name: Déploiement Symfony vers o2switch

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      APP_ENV: prod
      O2SWITCH_HOST: ${{ secrets.O2SWITCH_HOST }}
      O2SWITCH_PORT: ${{ secrets.O2SWITCH_PORT }}
      O2SWITCH_USER: ${{ secrets.O2SWITCH_USER }}
      O2SWITCH_SSH_KEY: ${{ secrets.O2SWITCH_SSH_KEY }}
      O2SWITCH_SSH_KEY_PASSPHRASE: ${{ secrets.O2SWITCH_SSH_KEY_PASSPHRASE }}
      # Chemin vers le dossier de staging (zone temporaires) sur le serveur o2switch
      O2SWITCH_DEPLOY_PATH: ${{ secrets.O2SWITCH_DEPLOY_PATH }}
      # Web-root de ton site (la racine publique) sur le serveur o2switch
      O2SWITCH_WEBROOT: ${{ secrets.O2SWITCH_WEBROOT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, pdo_mysql, opcache, zip
          tools: composer

      - name: Install dependencies (prod)
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction
          php bin/console asset-map:compile --env=prod
          php bin/console cache:clear --env=prod

      - name: Run PHPUnit if exists
        if: hashFiles('phpunit.xml*') != ''
        run: |
          if [ -x "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit --testdox
          else
            if [ -x "bin/phpunit" ]; then
              php bin/phpunit --testdox
            else
              echo "PHPUnit non disponible, étape ignorée."
            fi
          fi

      - name: Prepare release archive
        run: |
          zip -r release.zip . \
            -x "tests/*" ".git/*" ".github/*" "var/cache/*" "var/log/*" ".env*"

      - name: Upload release to o2switch
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.O2SWITCH_HOST }}
          port: ${{ env.O2SWITCH_PORT }}
          username: ${{ env.O2SWITCH_USER }}
          key: ${{ env.O2SWITCH_SSH_KEY }}
          passphrase: ${{ env.O2SWITCH_SSH_KEY_PASSPHRASE }}
          source: release.zip
          target: ${{ env.O2SWITCH_DEPLOY_PATH }}

      - name: Unzip & deploy on o2switch
        uses: appleboy/ssh-action@v1.0.2
        with:
          host: ${{ env.O2SWITCH_HOST }}
          port: ${{ env.O2SWITCH_PORT }}
          username: ${{ env.O2SWITCH_USER }}
          key: ${{ env.O2SWITCH_SSH_KEY }}
          passphrase: ${{ env.O2SWITCH_SSH_KEY_PASSPHRASE }}
          script: |
            set -euo pipefail

            cd "${{ env.O2SWITCH_DEPLOY_PATH }}"

            rm -rf release_tmp
            unzip -oq release.zip -d release_tmp

            # Copier dans ton dossier actuel du site
            rsync -a --delete --exclude='.env*' release_tmp/ "${{ env.O2SWITCH_WEBROOT }}/"

            rm -rf release_tmp release.zip

            cd "${{ env.O2SWITCH_WEBROOT }}"
            php bin/console cache:clear --env=prod
            # Si tu as des migrations :
            # php bin/console doctrine:migrations:migrate --env=prod --no-interaction || true
