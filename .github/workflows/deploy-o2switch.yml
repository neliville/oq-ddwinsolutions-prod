name: Deploy Symfony to o2switch

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      APP_ENV: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, pdo_mysql, opcache, zip
          tools: composer

      - name: Install dependencies (no dev)
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction
          # Si tu n'utilises pas AssetMapper, cette ligne ne fera rien de grave
          php bin/console asset-map:compile --env=prod || true
          php bin/console cache:clear --env=prod || true

      - name: Run PHPUnit (if configured)
        if: hashFiles('phpunit.xml*') != ''
        run: |
          if [ -x "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit --testdox
          else
            php bin/phpunit --testdox || true
          fi

      - name: Prepare release archive
        run: |
          zip -r release.zip . \
            -x "tests/*" ".git/*" ".github/*" "var/cache/*" "var/log/*" ".env*"

      - name: Upload release to o2switch
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.O2SWITCH_HOST }}
          port: ${{ secrets.O2SWITCH_PORT }}
          username: ${{ secrets.O2SWITCH_USER }}
          key: ${{ secrets.O2SWITCH_SSH_KEY }}
          source: release.zip
          target: ${{ secrets.O2SWITCH_DEPLOY_PATH }}

      - name: Unzip & deploy on o2switch
        uses: appleboy/ssh-action@v1.0.2
        with:
          host: ${{ secrets.O2SWITCH_HOST }}
          port: ${{ secrets.O2SWITCH_PORT }}
          username: ${{ secrets.O2SWITCH_USER }}
          key: ${{ secrets.O2SWITCH_SSH_KEY }}
          script: |
            set -euo pipefail

            # Aller dans le dossier tampon
            cd "${{ secrets.O2SWITCH_DEPLOY_PATH }}"

            # Décompression propre
            rm -rf release_tmp
            unzip -oq release.zip -d release_tmp

            # Sync vers le dossier du projet en prod
            # --delete : nettoie les vieux fichiers
            # --exclude='.env*' : NE TOUCHE PAS à .env.prod.local sur le serveur
            rsync -a --delete --exclude='.env*' \
              release_tmp/ "${{ secrets.O2SWITCH_WEBROOT }}/"

            # Nettoyage
            rm -rf release_tmp release.zip

            # Rebuild cache Symfony en prod
            cd "${{ secrets.O2SWITCH_WEBROOT }}"
            php bin/console cache:clear --env=prod || true
            # Décommente quand tu es prêt à automatiser les migrations :
            # php bin/console doctrine:migrations:migrate --env=prod --no-interaction || true
