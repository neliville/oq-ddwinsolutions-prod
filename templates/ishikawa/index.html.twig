{% extends (app.user ? 'base_with_sidebar.html.twig' : 'base.html.twig') %}

{% block title %}Diagramme d'Ishikawa | Analyse des causes{% endblock %}

{% block meta_description %}Créez votre diagramme d'Ishikawa interactif gratuitement. Diagramme de causes et effets 100% personnalisable. Outil professionnel avec export PDF, JPEG, JSON.{% endblock %}

{% block meta_keywords %}diagramme Ishikawa, fishbone diagram, diagramme de causes et effets, analyse des causes, root cause analysis, Kaoru Ishikawa, outil qualité gratuit, amélioration continue{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/pages/ishikawa.scss') }}" data-turbo-track="reload">
{% endblock %}

{% block content %}
<div class="ishikawa-page">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Diagramme d'Ishikawa</h1>
        <div class="info-banner">
            <p class="info-text">
                Certaines catégories et causes sont déjà pré-chargées pour vous aider à démarrer. Vous pouvez déplacer librement chaque catégorie pour ajuster sa position. Pour une expérience complète, utilisez un grand écran!
            </p>
            <p class="info-text">
                Vider les causes pour commencer une nouvelle analyse.
            </p>
        </div>
    </div>

    <div class="ishikawa-content">
        {{ include('components/ishikawa_canvas.html.twig', { diagramId: diagramId }) }}
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}


<!-- Toastify CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Toastify JS -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <!-- Bibliothèques d'export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Scripts globaux -->
    <script src="{{ asset('js/main.js') }}" data-turbo-track="reload"></script>
    <!-- Ishikawa JS - Chargé après le DOM pour éviter les problèmes d'initialisation -->
    <script src="{{ asset('js/ishikawa.js') }}" data-turbo-track="reload"></script>
    
    {% if app.user %}
    <script>
        // Fonction de sauvegarde via API (similaire à saveFiveWhy)
        async function saveIshikawa() {
            const Toastify = window.Toastify;
            
            if (!Toastify) {
                alert('Erreur : Bibliothèque Toastify non chargée');
                return;
            }
            
            // Récupérer les données du diagramme via la fonction exposée
            let diagramData = {};
            
            if (window.ishikawaApp && typeof window.ishikawaApp.getDiagramData === 'function') {
                diagramData = window.ishikawaApp.getDiagramData();
            } else {
                Toastify({
                    text: "Erreur : Impossible de récupérer les données du diagramme.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
                return;
            }
            
            const problemInput = document.getElementById('problemInput');
            const problem = problemInput ? problemInput.value : '';
            const diagramIdInput = document.getElementById('ishikawaDiagramId');
            const existingId = diagramIdInput && diagramIdInput.value ? parseInt(diagramIdInput.value, 10) : null;
            
            const saveBtn = document.getElementById('saveIshikawaBtn');
            const originalText = saveBtn.innerHTML;
            
            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sauvegarde...';
                
                const payload = {
                    title: problem || 'Diagramme Ishikawa - ' + new Date().toLocaleDateString('fr-FR'),
                    problem: problem,
                    content: diagramData
                };

                if (existingId) {
                    payload.id = existingId;
                }

                const response = await fetch('{{ path('app_api_ishikawa_save') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    Toastify({
                        text: "Diagramme sauvegardé avec succès !",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    }).showToast();

                    if (diagramIdInput && data.data && data.data.id) {
                        diagramIdInput.value = data.data.id;
                    }
                } else {
                    throw new Error(data.message || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                Toastify({
                    text: "Erreur lors de la sauvegarde : " + error.message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        async function shareIshikawa() {
            const Toastify = window.Toastify;
            const shareBtn = document.getElementById('shareIshikawaBtn');
            const diagramIdInput = document.getElementById('ishikawaDiagramId');

            if (!diagramIdInput || !diagramIdInput.value) {
                Toastify({
                    text: "Sauvegardez le diagramme avant de le partager.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #f97316, #ea580c)",
                }).showToast();
                return;
            }

            try {
                shareBtn.disabled = true;
                shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Partage...';

                const response = await fetch('{{ path('app_api_ishikawa_share') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        id: parseInt(diagramIdInput.value, 10)
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Impossible de générer le lien de partage');
                }

                const shareUrl = data.data.url;
                const expiration = data.data.expiresAt ? new Date(data.data.expiresAt) : null;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(shareUrl);
                    Toastify({
                        text: `Lien copié dans le presse-papiers ! Ce lien public reste valide pendant un mois${expiration ? ', jusqu\'au ' + expiration.toLocaleDateString('fr-FR') : ''}.`,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #14b8a6, #0ea5e9)",
                    }).showToast();
                } else {
                    prompt("Copiez ce lien pour partager votre diagramme :", shareUrl);
                }
            } catch (error) {
                console.error('Erreur lors du partage:', error);
                Toastify({
                    text: "Erreur lors du partage : " + error.message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
            } finally {
                shareBtn.disabled = false;
                shareBtn.innerHTML = '<i class="fas fa-share-alt me-2"></i>Partager';
            }
        }
    </script>
    {% endif %}

    {% if diagramId %}
    <script>
        (function() {
            const isAuthenticated = Boolean({{ app.user ? 1 : 0 }});
            const requestUrl = '{{ path('app_api_ishikawa_get', {id: diagramId}) }}';

            function notify(message, type = 'info') {
                const Toastify = window.Toastify;
                if (Toastify) {
                    const colors = {
                        success: 'linear-gradient(to right, #22c55e, #16a34a)',
                        error: 'linear-gradient(to right, #ef4444, #dc2626)',
                        warning: 'linear-gradient(to right, #f97316, #ea580c)',
                        info: 'linear-gradient(to right, #2563eb, #38bdf8)'
                    };
                    Toastify({
                        text: message,
                        duration: 3200,
                        close: true,
                        gravity: 'top',
                        position: 'right',
                        backgroundColor: colors[type] || colors.info,
                    }).showToast();
                } else {
                    if (type === 'error') {
                        console.error(message);
                    } else {
                        console.log(message);
                    }
                }
            }

            async function fetchDiagram() {
                try {
                    const response = await fetch(requestUrl, {
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const payload = await response.json();
                    if (!payload || payload.success === false) {
                        throw new Error(payload?.message || 'Diagramme introuvable.');
                    }

                    const data = payload.data || {};
                    const content = data.content ? { ...data.content } : {};
                    if (typeof content.problem !== 'string' && typeof data.problem === 'string') {
                        content.problem = data.problem;
                    }
                    if (!Array.isArray(content.categories)) {
                        content.categories = [];
                    }
 
                    if (window.ishikawaApp && typeof window.ishikawaApp.loadDiagramData === 'function') {
                        window.ishikawaApp.loadDiagramData(content);
                        const diagramIdInput = document.getElementById('ishikawaDiagramId');
                        if (diagramIdInput) {
                            diagramIdInput.value = data.id ?? '';
                        }
                        notify('Diagramme chargé avec succès.', 'success');
                    }
                } catch (error) {
                    console.error('Ishikawa: erreur lors du chargement du diagramme', error);
                    notify('Impossible de charger le diagramme sauvegardé.', 'error');
                }
            }

            function bootstrapLoading() {
                if (!isAuthenticated) {
                    notify('Connectez-vous pour charger vos diagrammes sauvegardés.', 'warning');
                    return;
                }

                if (window.ishikawaApp && typeof window.ishikawaApp.loadDiagramData === 'function' && window.ishikawaApp.isReady) {
                    fetchDiagram();
                } else {
                    const handler = () => {
                        window.removeEventListener('ishikawa:ready', handler);
                        fetchDiagram();
                    };
                    window.addEventListener('ishikawa:ready', handler, { once: true });
                }
            }

            if (typeof window.requestAnimationFrame === 'function') {
                window.requestAnimationFrame(bootstrapLoading);
            } else {
                bootstrapLoading();
            }
        })();
    </script>
    {% endif %}
{% endblock %}
