{% extends (app.user ? 'base_with_sidebar.html.twig' : 'base.html.twig') %}

{% block title %}Diagramme d'Ishikawa en Ligne Gratuit — Créez et Exportez en PDF | Outils-Qualité{% endblock %}

{% block meta_description %}Créez votre diagramme d'Ishikawa (arête de poisson) en ligne gratuitement. Catégories 5M/6M personnalisables, export PDF professionnel pour vos audits ISO 9001.{% endblock %}

{% block meta_keywords %}diagramme Ishikawa, fishbone diagram, diagramme de causes et effets, analyse des causes, root cause analysis, Kaoru Ishikawa, outil qualité gratuit, amélioration continue{% endblock %}

{% block schema_webapp_json %}
{"@context":"https://schema.org","@type":"WebApplication","name":"Diagramme d'Ishikawa en ligne","url":{{ absolute_url(path('app_ishikawa_index'))|json_encode|raw }},"applicationCategory":"BusinessApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"EUR"},"description":"Créez votre diagramme d'Ishikawa (arête de poisson) en ligne. Catégories 5M/6M personnalisables, export PDF professionnel.","featureList":["Catégories 5M/6M personnalisables","Export PDF haute qualité","Sauvegarde automatique","Conforme ISO 9001"]}
{% endblock %}

{% block schema_breadcrumb_json %}
{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Accueil","item":{{ absolute_url(path('app_home_index'))|json_encode|raw }}},{"@type":"ListItem","position":2,"name":"Outils","item":{{ absolute_url(path('app_outils_index'))|json_encode|raw }}},{"@type":"ListItem","position":3,"name":"Diagramme d'Ishikawa","item":{{ absolute_url(path('app_ishikawa_index'))|json_encode|raw }}}]}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/tools/ishikawa.scss') }}" data-turbo-track="reload">
{% endblock %}

{% block content %}
<div class="ishikawa-page">
    <div class="container">
        {% include 'components/tool_breadcrumb.html.twig' with { tool_name: "Diagramme d'Ishikawa" } %}
    </div>
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Visualisez toutes les causes possibles d'un problème — méthode Ishikawa (5M)</h1>
        {% set meta = tool_meta('ishikawa') %}
        {% if meta %}
        <div class="d-flex flex-wrap gap-2 mb-3" role="list">
            <span class="badge bg-secondary" role="listitem">Niveau : {{ meta.level }}</span>
            {% for tag in meta.tags %}
            <span class="badge bg-light text-dark" role="listitem">{{ tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
        <div class="info-banner">
            <p class="info-text">
                Certaines catégories et causes sont déjà pré-chargées pour vous aider à démarrer. Vous pouvez déplacer librement chaque catégorie pour ajuster sa position. Pour une expérience complète, utilisez un grand écran!
            </p>
            <p class="info-text">
                Vider les causes pour commencer une nouvelle analyse.
            </p>
        </div>
    </div>

    <div class="container">
        <section class="mb-4" aria-labelledby="ishikawa-when-heading">
            <h2 id="ishikawa-when-heading" class="h5 fw-bold mb-2">Quand utiliser cette méthode en QSE ?</h2>
            <ul class="mb-0">
                <li>Analyse de <strong>non-conformité</strong> ou de réclamation client</li>
                <li>Recherche des <strong>causes racines</strong> avant mise en place d'actions correctives</li>
                <li>Revue de processus, <strong>audit interne</strong> ou préparation certification</li>
                <li>Niveau recommandé : <strong>Débutant</strong> à Intermédiaire</li>
            </ul>
        </section>
        <section class="mb-4 p-3 bg-light rounded" aria-labelledby="ishikawa-example-heading">
            <h2 id="ishikawa-example-heading" class="h6 fw-bold mb-2">Exemple d'application</h2>
            <p class="mb-1"><strong>Problème :</strong> Erreur de production augmentée de 12 % sur la ligne 3.</p>
            <p class="mb-0"><strong>Causes possibles (5M) :</strong> Main-d'œuvre (formation), Machine (réglage), Milieu (température), Matière (fournisseur), Méthode (instruction). Le diagramme permet de visualiser et prioriser les pistes.</p>
        </section>
        <section class="mb-4" aria-labelledby="ishikawa-guide-heading">
            <h2 id="ishikawa-guide-heading" class="h5 fw-bold mb-2">Mini-guide</h2>
            <p class="mb-1"><strong>Comment remplir un diagramme :</strong> Inscrivez le problème dans l'encadré à droite, puis répartissez les causes par catégorie (5M ou 6M). Une cause peut apparaître dans plusieurs branches.</p>
            <p class="mb-1"><strong>Erreurs fréquentes :</strong> Trop de causes vagues, mélanger causes et solutions, s'arrêter aux causes immédiates.</p>
            <p class="mb-0"><strong>Conseil d'expert :</strong> Validez les causes avec des données (mesures, retours terrain) avant de lancer les actions.</p>
        </section>
        <p class="mb-0">
            <a href="{{ path('app_telechargement_modele_5m') }}" class="btn btn-sm btn-outline-primary">Téléchargez un modèle prêt à l'emploi (.xlsx / PDF) + astuces d'analyse 5M</a>
        </p>
    </div>

    <div class="ishikawa-content">
        {{ include('components/ishikawa_canvas.html.twig', { diagramId: diagramId }) }}
    </div>

    <div class="container">
        {% include 'components/tool_lead_cta.html.twig' %}
        {% include 'components/cta_ddwin.html.twig' %}

        <section class="seo-content">
            <h2>Qu'est-ce que le diagramme d'Ishikawa ?</h2>
            <p>Outil d'analyse des causes développé par Kaoru Ishikawa dans les années 1960, aussi appelé diagramme en arête de poisson ou diagramme causes-effets. Utilisé dans les démarches ISO 9001 et Lean Manufacturing pour identifier systématiquement les causes d'un problème.</p>

            <h2>Comment utiliser le diagramme d'Ishikawa ?</h2>
            <p>(1) Définir le problème (l'effet). (2) Identifier les catégories principales (5M ou 6M : Main-d'œuvre, Matières, Méthodes, Machines, Milieu, Management). (3) Lister les causes possibles dans chaque catégorie. (4) Analyser et prioriser les causes racines. (5) Définir un plan d'action.</p>

            <h2>Quand utiliser le diagramme d'Ishikawa ?</h2>
            <p>Analyse de non-conformité en production, investigation d'un défaut qualité client, revue de processus, préparation d'un audit ISO 9001.</p>

            <h2>Pourquoi utiliser notre outil en ligne ?</h2>
            <p>Création visuelle interactive, catégories personnalisables, drag & drop, export PDF prêt pour audit, sauvegarde automatique.</p>
        </section>
    </div>

    {# Modal pour afficher les analyses Ishikawa sauvegardées #}
    {% if app.user %}
    {% component IshikawaAnalysesModal with {
        id: 'ishikawaLoadModal'
    } %}
    {% endcomponent %}
    {% else %}
    {% include 'components/save_guest_modal.html.twig' with { tool: 'ishikawa' } %}
    {% endif %}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}


<!-- Toastify CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Toastify JS -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <!-- Bibliothèques d'export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Scripts globaux -->
    <script src="{{ asset('js/main.js') }}" data-turbo-track="reload"></script>
    <script>
        window.ishikawaReadonly = false;
        window.ishikawaIsGuest = {{ app.user ? 'false' : 'true' }};
    </script>
    <!-- Ishikawa JS - Chargé après le DOM pour éviter les problèmes d'initialisation -->
    <script src="{{ asset('js/ishikawa.js') }}" data-turbo-track="reload"></script>
    {% if not app.user %}
    <script>
        document.addEventListener('show-save-guest-modal', function () {
            var el = document.getElementById('saveGuestModal');
            if (el && typeof window.bootstrap !== 'undefined' && window.bootstrap.Modal) {
                window.bootstrap.Modal.getOrCreateInstance(el).show();
            }
        });
    </script>
    {% endif %}
    {% if app.user %}
    <script>
        // Fonction de sauvegarde via API (similaire à saveFiveWhy)
        async function saveIshikawa() {
            const Toastify = window.Toastify;
            
            if (!Toastify) {
                alert('Erreur : Bibliothèque Toastify non chargée');
                return;
            }
            
            // Récupérer les données du diagramme via la fonction exposée
            let diagramData = {};
            
            if (window.ishikawaApp && typeof window.ishikawaApp.getDiagramData === 'function') {
                diagramData = window.ishikawaApp.getDiagramData();
            } else {
                Toastify({
                    text: "Erreur : Impossible de récupérer les données du diagramme.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
                return;
            }
            
            const problemInput = document.getElementById('problemInput');
            const problem = problemInput ? problemInput.value : '';
            const diagramIdInput = document.getElementById('ishikawaDiagramId');
            const existingId = diagramIdInput && diagramIdInput.value ? parseInt(diagramIdInput.value, 10) : null;
            
            const saveBtn = document.getElementById('saveIshikawaBtn');
            const originalText = saveBtn.innerHTML;
            
            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sauvegarde...';
                
                const payload = {
                    title: problem || 'Diagramme Ishikawa - ' + new Date().toLocaleDateString('fr-FR'),
                    problem: problem,
                    content: diagramData
                };

                if (existingId) {
                    payload.id = existingId;
                }

                const response = await fetch('{{ path('app_tool_ishikawa_save') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    Toastify({
                        text: "Diagramme sauvegardé avec succès !",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    }).showToast();

                    if (diagramIdInput && data.data && data.data.id) {
                        diagramIdInput.value = data.data.id;
                    }
                } else {
                    throw new Error(data.message || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                Toastify({
                    text: "Erreur lors de la sauvegarde : " + error.message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        async function shareIshikawa() {
            const Toastify = window.Toastify;
            const shareBtn = document.getElementById('shareIshikawaBtn');
            const diagramIdInput = document.getElementById('ishikawaDiagramId');

            if (!diagramIdInput || !diagramIdInput.value) {
                Toastify({
                    text: "Sauvegardez le diagramme avant de le partager.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #f97316, #ea580c)",
                }).showToast();
                return;
            }

            try {
                shareBtn.disabled = true;
                shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Partage...';

                const response = await fetch('{{ path('app_api_ishikawa_share') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({
                        id: parseInt(diagramIdInput.value, 10)
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Impossible de générer le lien de partage');
                }

                const shareUrl = data.data.url;
                const expiration = data.data.expiresAt ? new Date(data.data.expiresAt) : null;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(shareUrl);
                    Toastify({
                        text: `Lien copié dans le presse-papiers ! Ce lien public reste valide pendant un mois${expiration ? ', jusqu\'au ' + expiration.toLocaleDateString('fr-FR') : ''}.`,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #14b8a6, #0ea5e9)",
                    }).showToast();
                } else {
                    prompt("Copiez ce lien pour partager votre diagramme :", shareUrl);
                }
            } catch (error) {
                console.error('Erreur lors du partage:', error);
                Toastify({
                    text: "Erreur lors du partage : " + error.message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
            } finally {
                shareBtn.disabled = false;
                shareBtn.innerHTML = '<i class="fas fa-share-alt me-2"></i>Partager';
            }
        }

        async function openIshikawaSaved() {
            if (!{{ app.user ? 'true' : 'false' }}) {
                const Toastify = window.Toastify;
                if (Toastify) {
                    Toastify({
                        text: "Connectez-vous pour accéder à vos analyses.",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #f97316, #ea580c)",
                    }).showToast();
                }
                return;
            }

            try {
                const response = await fetch('{{ path('app_tool_ishikawa_list') }}', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                const data = await response.json();
                const analyses = data.data || [];

                if (!analyses.length) {
                    const Toastify = window.Toastify;
                    if (Toastify) {
                        Toastify({
                            text: "Aucune analyse Ishikawa sauvegardée.",
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "linear-gradient(to right, #3b82f6, #2563eb)",
                        }).showToast();
                    }
                    return;
                }

                // Trouver le modal existant (créé via le composant Twig)
                const modalElement = document.getElementById('ishikawaLoadModal');
                if (!modalElement) {
                    const Toastify = window.Toastify;
                    if (Toastify) {
                        Toastify({
                            text: "Le modal n'est pas disponible.",
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                        }).showToast();
                    }
                    return;
                }

                // Trouver la liste dans le modal
                const listContainer = modalElement.querySelector('#ishikawaAnalysesList');
                if (!listContainer) {
                    const Toastify = window.Toastify;
                    if (Toastify) {
                        Toastify({
                            text: "Le conteneur de la liste n'est pas disponible.",
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                        }).showToast();
                    }
                    return;
                }

                // Générer le HTML de la liste des analyses
                const listHtml = analyses
                    .map(
                        (analysis) => `
                        <button type="button" class="list-group-item list-group-item-action" data-analysis-id="${analysis.id}">
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-1">${analysis.title || 'Sans titre'}</h6>
                                <small>${analysis.updatedAt ? new Date(analysis.updatedAt).toLocaleDateString('fr-FR') : new Date(analysis.createdAt).toLocaleDateString('fr-FR')}</small>
                            </div>
                            <p class="mb-0 text-muted small">${analysis.problem || 'Diagramme Ishikawa'}</p>
                        </button>
                    `
                    )
                    .join('');

                listContainer.innerHTML = listHtml;

                // Réinitialiser les icônes Lucide
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Ajouter les event listeners pour charger les analyses
                listContainer.querySelectorAll('[data-analysis-id]').forEach((button) => {
                    button.addEventListener('click', async (event) => {
                        const selectedId = event.currentTarget.getAttribute('data-analysis-id');
                        // Rediriger vers la page avec l'ID
                        window.location.href = '{{ path('app_ishikawa_index') }}?load=' + selectedId;
                    });
                });

                // Ouvrir le modal via le contrôleur bootstrap-modal
                let modalController = null;
                
                if (window.Stimulus && typeof window.Stimulus.getControllerForElementAndIdentifier === 'function') {
                    try {
                        modalController = window.Stimulus.getControllerForElementAndIdentifier(modalElement, 'bootstrap-modal');
                    } catch (e) {
                        console.warn('Impossible de récupérer le contrôleur Stimulus:', e);
                    }
                }

                if (modalController && typeof modalController.show === 'function') {
                    modalController.show();
                } else {
                    // Fallback vers Bootstrap natif
                    const bootstrapLib = window.bootstrap || (await new Promise(resolve => {
                        if (window.bootstrap) resolve(window.bootstrap);
                        else setTimeout(() => resolve(window.bootstrap), 100);
                    }));
                    if (!bootstrapLib?.Modal) {
                        const Toastify = window.Toastify;
                        if (Toastify) {
                            Toastify({
                                text: "Le module d'interface Bootstrap n'est pas disponible.",
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                            }).showToast();
                        }
                        return;
                    }
                    const modalInstance = new bootstrapLib.Modal(modalElement);
                    modalInstance.show();
                }
            } catch (error) {
                console.error(error);
                const Toastify = window.Toastify;
                if (Toastify) {
                    Toastify({
                        text: error.message || 'Erreur lors du chargement des analyses.',
                        duration: 5000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                    }).showToast();
                }
            }
        }

        window.openIshikawaSaved = openIshikawaSaved;
    </script>
    {% endif %}

    {% if diagramId %}
    <script>
        (function() {
            const isAuthenticated = Boolean({{ app.user ? 1 : 0 }});
            const requestUrl = '{{ path('app_tool_ishikawa_get', {id: diagramId}) }}';

            function notify(message, type = 'info') {
                const Toastify = window.Toastify;
                if (Toastify) {
                    const colors = {
                        success: 'linear-gradient(to right, #22c55e, #16a34a)',
                        error: 'linear-gradient(to right, #ef4444, #dc2626)',
                        warning: 'linear-gradient(to right, #f97316, #ea580c)',
                        info: 'linear-gradient(to right, #2563eb, #38bdf8)'
                    };
                    Toastify({
                        text: message,
                        duration: 3200,
                        close: true,
                        gravity: 'top',
                        position: 'right',
                        backgroundColor: colors[type] || colors.info,
                    }).showToast();
                } else {
                    if (type === 'error') {
                        console.error(message);
                    } else {
                        console.log(message);
                    }
                }
            }

            async function fetchDiagram() {
                try {
                    const response = await fetch(requestUrl, {
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const payload = await response.json();
                    if (!payload || payload.success === false) {
                        throw new Error(payload?.message || 'Diagramme introuvable.');
                    }

                    const data = payload.data || {};
                    const content = data.content ? { ...data.content } : {};
                    if (typeof content.problem !== 'string' && typeof data.problem === 'string') {
                        content.problem = data.problem;
                    }
                    if (!Array.isArray(content.categories)) {
                        content.categories = [];
                    }
 
                    if (window.ishikawaApp && typeof window.ishikawaApp.loadDiagramData === 'function') {
                        window.ishikawaApp.loadDiagramData(content);
                        const diagramIdInput = document.getElementById('ishikawaDiagramId');
                        if (diagramIdInput) {
                            diagramIdInput.value = data.id ?? '';
                        }
                        notify('Diagramme chargé avec succès.', 'success');
                    }
                } catch (error) {
                    console.error('Ishikawa: erreur lors du chargement du diagramme', error);
                    notify('Impossible de charger le diagramme sauvegardé.', 'error');
                }
            }

            function bootstrapLoading() {
                if (!isAuthenticated) {
                    notify('Connectez-vous pour charger vos diagrammes sauvegardés.', 'warning');
                    return;
                }

                if (window.ishikawaApp && typeof window.ishikawaApp.loadDiagramData === 'function' && window.ishikawaApp.isReady) {
                    fetchDiagram();
                } else {
                    const handler = () => {
                        window.removeEventListener('ishikawa:ready', handler);
                        fetchDiagram();
                    };
                    window.addEventListener('ishikawa:ready', handler, { once: true });
                }
            }

            if (typeof window.requestAnimationFrame === 'function') {
                window.requestAnimationFrame(bootstrapLoading);
            } else {
                bootstrapLoading();
            }
        })();
    </script>
    {% endif %}
{% endblock %}
