{% extends (app.user ? 'base_with_sidebar.html.twig' : 'base.html.twig') %}

{% block title %}M√©thode 5 Pourquoi en Ligne ‚Äî Analyse de Cause Racine Gratuite | Outils-Qualit√©{% endblock %}

{% block meta_description %}Utilisez la m√©thode des 5 Pourquoi en ligne pour identifier les causes racines de vos probl√®mes. Outil gratuit avec export PDF conforme ISO 9001.{% endblock %}

{% block meta_keywords %}5 pourquoi, m√©thode des 5 pourquoi, 5 whys, analyse des causes racines, root cause analysis, Sakichi Toyoda, outil qualit√© gratuit, am√©lioration continue, r√©solution de probl√®mes{% endblock %}

{% block og_title %}M√©thode des 5 Pourquoi - Outil Gratuit | OUTILS-QUALIT√â{% endblock %}

{% block og_description %}Utilisez la m√©thode des 5 Pourquoi pour identifier les causes racines. Outil gratuit et professionnel avec export PDF.{% endblock %}

{% block schema_type %}{{ parent() }},SoftwareApplication{% endblock %}

{% block schema_data %}
{
    "name": "Outil M√©thode des 5 Pourquoi",
    "description": "Utilisez la m√©thode des 5 Pourquoi pour identifier les causes racines. Outil gratuit et professionnel avec export PDF.",
    "url": "{{ absolute_url(path('app_fivewhy_index')) }}",
    "screenshot": "{{ app.request.schemeAndHttpHost ~ asset('img/og-default.jpg') }}"
}
{% endblock %}

{% block schema_webapp_json %}
{"@context":"https://schema.org","@type":"WebApplication","name":"M√©thode 5 Pourquoi en ligne","url":{{ absolute_url(path('app_fivewhy_index'))|json_encode|raw }},"applicationCategory":"BusinessApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"EUR"},"description":"Utilisez la m√©thode des 5 Pourquoi en ligne pour identifier les causes racines de vos probl√®mes. Outil gratuit avec export PDF conforme ISO 9001.","featureList":["Analyse guid√©e pas √† pas","Export PDF structur√©","Visualisation cha√Æne causale","Conforme ISO 9001"]}
{% endblock %}

{% block schema_breadcrumb_json %}
{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Accueil","item":{{ absolute_url(path('app_home_index'))|json_encode|raw }}},{"@type":"ListItem","position":2,"name":"Outils","item":{{ absolute_url(path('app_outils_index'))|json_encode|raw }}},{"@type":"ListItem","position":3,"name":"M√©thode des 5 Pourquoi","item":{{ absolute_url(path('app_fivewhy_index'))|json_encode|raw }}}]}
{% endblock %}

{% block content %}
<!-- Main Content -->
<main class="five-why-main{% if not app.user %} five-why-main--guest{% endif %}">
    <div class="container">
        {% include 'components/tool_breadcrumb.html.twig' with { tool_name: "M√©thode des 5 Pourquoi" } %}
        <input type="hidden" id="fiveWhyAnalysisId" value="{{ analysisId ?? '' }}">
        <!-- Header compact -->
        <div class="five-why-header" data-aos="fade-up">
            <h1>Analyse des causes racines (m√©thode 5 Pourquoi)</h1>
            <p class="lead">R√©solvez les probl√®mes rapidement et efficacement en remontant jusqu'√† la cause racine gr√¢ce aux ¬´ Pourquoi ¬ª successifs.</p>
            {% set meta = tool_meta('fivewhy') %}
            {% if meta %}
            <div class="d-flex flex-wrap gap-2 mb-2" role="list">
                <span class="badge bg-secondary" role="listitem">Niveau : {{ meta.level }}</span>
                {% for tag in meta.tags %}
                <span class="badge bg-light text-dark" role="listitem">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Message pour utilisateurs non connect√©s -->
        {% if not app.user %}
        <div class="alert alert-warning text-center mb-3" role="alert" aria-live="polite" data-aos="fade-up" data-aos-delay="50">
            <i data-lucide="info" width="18" height="18" class="me-2" aria-hidden="true"></i>
            <strong>Vous n'√™tes pas connect√©.</strong> 
            <a href="{{ path('app_login') }}" class="alert-link">Connectez-vous</a> pour sauvegarder vos cr√©ations et acc√©der √† votre espace personnel.
        </div>
        {% endif %}

        <section class="mb-4" aria-labelledby="fivewhy-when-heading" data-aos="fade-up" data-aos-delay="70">
            <h2 id="fivewhy-when-heading" class="h5 fw-bold mb-2">Quand utiliser cette m√©thode en QSE ?</h2>
            <ul class="mb-0">
                <li><strong>Pour quel type de probl√®me :</strong> incident, non-conformit√©, panne, d√©rive processus</li>
                <li>Id√©al pour aller au-del√† de la cause imm√©diate et √©viter les r√©cidives</li>
                <li>Niveau requis : <strong>D√©butant</strong></li>
            </ul>
        </section>
        <section class="mb-4 p-3 bg-light rounded" aria-labelledby="fivewhy-example-heading" data-aos="fade-up" data-aos-delay="80">
            <h2 id="fivewhy-example-heading" class="h6 fw-bold mb-2">Exemple concret</h2>
            <p class="mb-0">R√©solution d'une non-conformit√© client en 5 √©tapes : Probl√®me ‚Üí Pourquoi #1 (retard livraison) ‚Üí #2 (commande non pr√©par√©e) ‚Üí #3 (stock non mis √† jour) ‚Üí #4 (proc√©dure non suivie) ‚Üí #5 (formation insuffisante). Cause racine : plan de formation √† revoir.</p>
        </section>

        <!-- Instructions compactes -->
        <div class="guide-card mb-3" role="region" aria-label="Instructions" data-aos="fade-up" data-aos-delay="90">
            <div class="guide-card__title">üß≠ Guide rapide</div>
            <ul class="guide-card__list mb-0 mt-2">
                <li>D√©finissez le <strong>probl√®me</strong> clairement</li>
                <li>Posez votre <strong>1er ¬´ Pourquoi ¬ª</strong> et remplissez la r√©ponse</li>
                <li>Ajoutez jusqu'√† <strong>7 √©tapes</strong> pour trouver la cause racine</li>
            </ul>
        </div>

        <!-- Controls compacts -->
        <div class="five-why-controls tool-actions-bar d-flex flex-wrap align-items-center gap-2 mb-3" data-aos="fade-up" data-aos-delay="100" role="toolbar" aria-label="Actions disponibles">
            <button class="btn btn-primary btn-sm" onclick="resetAnalysis()" aria-label="R√©initialiser l'analyse">
                <i class="fas fa-refresh me-2" aria-hidden="true"></i>Nouvelle analyse
            </button>
            <button id="addWhyStepButton" class="btn btn-info btn-sm" onclick="addWhyStep()" aria-label="Ajouter une √©tape Pourquoi">
                <i class="fas fa-plus me-2"></i>G√©n√©rer le rapport
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="resetWhySteps()" aria-label="R√©initialiser les √©tapes" style="display:none;" id="resetWhyBtn">
                <i class="fas fa-eraser me-2"></i>R√©initialiser
            </button>
            {% if app.user %}
            <button id="saveBtn" class="btn btn-success btn-sm" onclick="saveFiveWhy()" aria-label="Sauvegarder l'analyse">
                <i class="fas fa-save me-2" aria-hidden="true"></i>Sauvegarder
            </button>
            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="openFiveWhySaved()" aria-label="Charger une analyse 5 Pourquoi">
                <i class="fas fa-folder-open me-2"></i>Mes analyses
            </button>
            <div class="dropdown export-dropdown" data-controller="dropdown-basic">
                <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="fiveWhyExportDropdown" data-dropdown-basic-target="button" data-action="click->dropdown-basic#toggle keydown.enter->dropdown-basic#toggle keydown.space->dropdown-basic#toggle keydown.arrow-down->dropdown-basic#openWithKeyboard keydown.arrow-up->dropdown-basic#openWithKeyboard" aria-haspopup="true" aria-expanded="false" aria-label="Options d'export">
                    <i class="fas fa-download me-2" aria-hidden="true"></i>Exporter
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="fiveWhyExportDropdown" data-dropdown-basic-target="menu" hidden role="menu">
                    <li><button class="dropdown-item" type="button" onclick="exportPNG()" role="menuitem">Exporter en PNG</button></li>
                    <li><button class="dropdown-item" type="button" onclick="exportJPEG()" role="menuitem">Exporter en JPEG</button></li>
                    <li><button class="dropdown-item" type="button" onclick="exportPDF()" role="menuitem">Exporter en PDF</button></li>
                    <li><button class="dropdown-item" type="button" onclick="exportJSON()" role="menuitem">Exporter en JSON</button></li>
                </ul>
            </div>
            {% else %}
            {% include 'components/tool_actions_login.html.twig' %}
            {% endif %}
        </div>

        <!-- Five Why Container -->
        <div class="five-why-container" data-aos="fade-up" data-aos-delay="100" id="fiveWhyContainer" role="main" aria-label="Zone d'analyse 5 Pourquoi">
            <!-- Problem Statement -->
            <div class="problem-statement" role="region" aria-labelledby="problem-title">
                <h3 id="problem-title">D√©finition du probl√®me</h3>
                <label for="problemStatement" class="visually-hidden">D√©crivez clairement le probl√®me que vous souhaitez analyser</label>
                <input type="text" 
                    id="problemStatement"
                    class="form-control"
                    placeholder="Ex: La production s'est arr√™t√©e pendant 2 heures..."
                    aria-label="D√©finition du probl√®me"
                    aria-describedby="problem-help"
                    onchange="updateProblemStatement()">
                <small id="problem-help" class="text-muted d-block mt-2">D√©crivez clairement le probl√®me que vous souhaitez analyser</small>
            </div>

            <!-- Why Chain -->
            <div class="why-chain" id="whyChain">
                <!-- Les √©tapes "Pourquoi" seront g√©n√©r√©es dynamiquement -->
            </div>

            <div id="fiveWhyClarityScore" class="small text-muted mb-2" aria-live="polite" style="display:none;"></div>
            <div id="rootCauseTrigger" class="root-cause-trigger" aria-live="polite"></div>

            <!-- Root Cause -->
            <div class="root-cause" id="rootCause" style="display: none;">
                <h3>Cause racine identifi√©e</h3>
                <p id="rootCauseText">La cause racine sera affich√©e ici une fois l'analyse termin√©e.</p>
            </div>
            <div class="root-cause mt-3" id="planActionBlock" style="display: none;" role="region" aria-labelledby="plan-action-title">
                <h3 id="plan-action-title">Conclusion et plan d'action propos√©</h3>
                <textarea id="planActionStatement" class="form-control" rows="3" placeholder="D√©crivez les actions correctives ou pr√©ventives √† mettre en place..." aria-label="Plan d'action"></textarea>
            </div>
        </div>

        <section class="alert alert-info mt-4" role="region" aria-labelledby="fivewhy-pitfalls-heading">
            <h2 id="fivewhy-pitfalls-heading" class="h6 fw-bold mb-2">Pi√®ges √† √©viter</h2>
            <ul class="mb-0 small">
                <li>S'arr√™ter trop t√¥t (avant d'atteindre une cause actionnable)</li>
                <li>Formuler des causes trop vagues ou des jugements</li>
                <li>M√©langer plusieurs causes dans un m√™me ¬´ Pourquoi ¬ª</li>
                <li>N√©gliger de valider la cause racine avec des donn√©es ou le terrain</li>
            </ul>
        </section>

        {% include 'components/tool_lead_cta.html.twig' %}
        {% include 'components/cta_ddwin.html.twig' %}

        <section class="seo-content">
            <h2>Qu'est-ce que la m√©thode des 5 Pourquoi ?</h2>
            <p>Technique d'analyse it√©rative d√©velopp√©e par Sakichi Toyoda chez Toyota. Consiste √† poser successivement la question ¬´ Pourquoi ? ¬ª (g√©n√©ralement 5 fois) pour remonter d'un sympt√¥me visible √† sa cause racine profonde.</p>

            <h2>Comment utiliser la m√©thode des 5 Pourquoi ?</h2>
            <p>(1) √ânoncer clairement le probl√®me observ√©. (2) Poser la premi√®re question ¬´ Pourquoi ce probl√®me se produit-il ? ¬ª. (3) Poser ¬´ Pourquoi ? ¬ª sur la r√©ponse obtenue. (4) R√©p√©ter jusqu'√† atteindre la cause racine (souvent 5 it√©rations). (5) D√©finir une action corrective sur la cause racine identifi√©e.</p>

            <h2>Quand utiliser la m√©thode des 5 Pourquoi ?</h2>
            <p>Analyse rapide d'un incident, investigation de r√©clamation client, r√©solution de panne r√©currente, analyse de retard de livraison.</p>

            <h2>Pourquoi utiliser notre outil en ligne ?</h2>
            <p>Outil guid√© pas √† pas, visualisation de la cha√Æne causale, export PDF structur√©.</p>
        </section>
    </div>

    {# Modal pour afficher les analyses 5 Pourquoi sauvegard√©es #}
    {% if app.user %}
    {% component FiveWhyAnalysesModal with {
        id: 'fiveWhyLoadModal'
    } %}
    {% endcomponent %}
    {% else %}
    {% include 'components/save_guest_modal.html.twig' with { tool: 'fivewhy' } %}
    {% endif %}
</main>
{% endblock %}

{% block stylesheets %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<!-- Toastify CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

<link rel="stylesheet" href="{{ asset('styles/tools/five-why.scss') }}" data-turbo-track="reload">
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{{ asset('js/main.js') }}"></script>
<script src="{{ asset('js/fivewhy.js') }}"></script>

<script>
    window.fiveWhyAppConfig = {
        isAuthenticated: {{ app.user ? 'true' : 'false' }},
        analysisId: {{ analysisId is defined and analysisId ? analysisId : 'null' }},
        currentAnalysisId: null,
    };

    function getCurrentFiveWhyAnalysisId() {
        const hiddenInput = document.getElementById('fiveWhyAnalysisId');
        if (hiddenInput && hiddenInput.value) {
            const parsed = parseInt(hiddenInput.value, 10);
            if (!Number.isNaN(parsed)) {
                return parsed;
            }
        }
        return window.fiveWhyAppConfig?.currentAnalysisId ?? null;
    }

    function setCurrentFiveWhyAnalysisId(id) {
        const hiddenInput = document.getElementById('fiveWhyAnalysisId');
        if (hiddenInput) {
            hiddenInput.value = id ? String(id) : '';
        }
        const normalizedId = id ? Number(id) : null;
        window.fiveWhyAppConfig.currentAnalysisId = normalizedId;
        window.fiveWhyAppConfig.analysisId = normalizedId;
    }

    window.setCurrentFiveWhyAnalysisId = setCurrentFiveWhyAnalysisId;

    function normalizeRootCause(rawValue) {
        if (typeof rawValue !== 'string') {
            return '';
        }
        const trimmed = rawValue.trim();
        if (!trimmed.length) {
            return '';
        }
        const match = trimmed.match(/La cause racine identifi√©e est : "(.*)"$/);
        if (match && match[1]) {
            return match[1];
        }
        return trimmed.replace(/^"+|"+$/g, '');
    }

    window.loadAnalysisData = function (rawContent = {}, options = {}) {
        try {
            if (typeof rawContent === 'string') {
                try {
                    rawContent = JSON.parse(rawContent);
                } catch (parseError) {
                    console.warn('Impossible d\'analyser les donn√©es de l\'analyse 5 Pourquoi.', parseError);
                    rawContent = {};
                }
            }

            const sanitizedSteps = Array.isArray(rawContent.whySteps) && rawContent.whySteps.length
                ? rawContent.whySteps
                : [{ question: '', answer: '' }];

            fiveWhyData.problemStatement = (rawContent.problemStatement ?? '').toString();
            fiveWhyData.whySteps = sanitizedSteps.map((step) => ({
                question: (step?.question ?? '').toString(),
                answer: (step?.answer ?? '').toString(),
            }));

            const rootCauseValue = normalizeRootCause(rawContent.rootCause ?? rawContent.rootCauseText ?? '');
            fiveWhyData.rootCause = rootCauseValue;
            fiveWhyData.rootCauseReady = Boolean(rawContent.rootCauseReady || rootCauseValue.length);
            fiveWhyData.planAction = (rawContent.planAction ?? '').toString();

            // Attendre que le DOM soit pr√™t avant de rendre
            const renderData = () => {
                const problemInput = document.getElementById('problemStatement');
                if (problemInput) {
                    problemInput.value = fiveWhyData.problemStatement;
                }

                if (typeof window.renderWhyChain === 'function') {
                    window.renderWhyChain();
                }
                if (typeof window.updateAddButtonVisibility === 'function') {
                    window.updateAddButtonVisibility();
                }
                if (typeof window.updateRootCauseDisplay === 'function') {
                    window.updateRootCauseDisplay({
                        force: fiveWhyData.rootCauseReady,
                        answerOverride: rootCauseValue,
                    });
                }

                if (fiveWhyData.rootCauseReady) {
                    const rootCauseDiv = document.getElementById('rootCause');
                    if (rootCauseDiv) rootCauseDiv.style.display = 'block';
                    const planActionBlock = document.getElementById('planActionBlock');
                    if (planActionBlock) planActionBlock.style.display = 'block';
                    const planActionStatement = document.getElementById('planActionStatement');
                    if (planActionStatement && fiveWhyData.planAction) planActionStatement.value = fiveWhyData.planAction;
                }
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', renderData);
            } else {
                // DOM d√©j√† charg√©, rendre imm√©diatement
                renderData();
            }

            if (options.id) {
                setCurrentFiveWhyAnalysisId(Number(options.id));
            }
        } catch (error) {
            console.error('Erreur lors du chargement de l\'analyse 5 Pourquoi :', error);
        }
    };

    async function saveFiveWhy() {
        if (!{{ app.user ? 'true' : 'false' }}) {
            Toastify({
                text: "Connectez-vous pour sauvegarder d√©finitivement.",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #f97316, #ea580c)",
            }).showToast();
            var modalEl = document.getElementById('saveGuestModal');
            if (modalEl && typeof window.bootstrap !== 'undefined' && window.bootstrap.Modal) {
                window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
            }
            return;
        }

        const problemStatement = document.getElementById('problemStatement')?.value || '';
        const analysisData = window.fiveWhyData || {};

        const sanitizedSteps = Array.isArray(analysisData.whySteps) && analysisData.whySteps.length
            ? analysisData.whySteps
            : [{ question: '', answer: '' }];

        const planActionEl = document.getElementById('planActionStatement');
        const planActionValue = (planActionEl ? planActionEl.value : analysisData.planAction || '').toString().trim();
        const payloadContent = {
            problemStatement,
            whySteps: sanitizedSteps.map((step) => ({
                question: (step?.question ?? '').toString(),
                answer: (step?.answer ?? '').toString(),
            })),
            rootCause: (analysisData.rootCause ?? '').toString(),
            rootCauseReady: Boolean(analysisData.rootCauseReady || (analysisData.rootCause && analysisData.rootCause.toString().trim())),
            planAction: planActionValue,
        };

        const payload = {
            title: problemStatement || 'Analyse 5 Pourquoi - ' + new Date().toLocaleDateString('fr-FR'),
            problem: problemStatement || null,
            content: payloadContent,
        };

        const existingId = getCurrentFiveWhyAnalysisId();
        if (existingId) {
            payload.id = existingId;
        }

        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn ? saveBtn.innerHTML : '';

        try {
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sauvegarde...';
            }

            const response = await fetch('{{ path('app_tool_fivewhy_save') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify(payload),
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.message || 'Erreur lors de la sauvegarde');
            }

            if (data.data?.id) {
                setCurrentFiveWhyAnalysisId(data.data.id);
            }

            fiveWhyData.problemStatement = problemStatement;
            fiveWhyData.rootCause = payloadContent.rootCause;
            fiveWhyData.rootCauseReady = payloadContent.rootCauseReady;
            fiveWhyData.planAction = payloadContent.planAction || '';
            fiveWhyData.whySteps = payloadContent.whySteps.map((step) => ({
                question: step.question,
                answer: step.answer,
            }));
            const planActionStatement = document.getElementById('planActionStatement');
            if (planActionStatement) planActionStatement.value = fiveWhyData.planAction;
            const planActionBlock = document.getElementById('planActionBlock');
            if (planActionBlock && fiveWhyData.rootCauseReady) planActionBlock.style.display = 'block';
            renderRootCauseTrigger();
            updateRootCauseDisplay({
                force: fiveWhyData.rootCauseReady,
                answerOverride: fiveWhyData.rootCause,
            });

            Toastify({
                text: data.message || "Analyse sauvegard√©e avec succ√®s !",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
            }).showToast();
        } catch (error) {
            console.error('Erreur lors de la sauvegarde:', error);
            Toastify({
                text: "Erreur lors de la sauvegarde : " + error.message,
                duration: 5000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
            }).showToast();
        } finally {
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }
    }

    async function loadFiveWhyList() {
        if (!{{ app.user ? 'true' : 'false' }}) {
            return;
        }

        try {
            const response = await fetch('{{ path('app_tool_fivewhy_list') }}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });

            const data = await response.json();

            if (data.data && data.data.length > 0) {
                showLoadModal(data.data);
            } else {
                Toastify({
                    text: "Aucune analyse sauvegard√©e.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ffa500, #ff8c00)",
                }).showToast();
            }
        } catch (error) {
            console.error('Erreur lors du chargement:', error);
            Toastify({
                text: "Erreur lors du chargement de la liste.",
                duration: 5000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
            }).showToast();
        }
    }

    async function openFiveWhySaved() {
        if (!{{ app.user ? 'true' : 'false' }}) {
            Toastify({
                text: "Connectez-vous pour acc√©der √† vos analyses.",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #f97316, #ea580c)",
            }).showToast();
            return;
        }

        try {
            const response = await fetch('{{ path('app_tool_fivewhy_list') }}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });

            const data = await response.json();
            const analyses = data.data || [];

            if (!analyses.length) {
                Toastify({
                    text: "Aucune analyse 5 Pourquoi sauvegard√©e.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #3b82f6, #2563eb)",
                }).showToast();
                return;
            }

            // Trouver le modal existant (cr√©√© via le composant Twig)
            const modalElement = document.getElementById('fiveWhyLoadModal');
            if (!modalElement) {
                Toastify({
                    text: "Le modal n'est pas disponible.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
                return;
            }

            // Trouver la liste dans le modal
            const listContainer = modalElement.querySelector('#fiveWhyAnalysesList');
            if (!listContainer) {
                Toastify({
                    text: "Le conteneur de la liste n'est pas disponible.",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
                return;
            }

            // G√©n√©rer le HTML de la liste des analyses
            const listHtml = analyses
                .map(
                    (analysis) => `
                    <button type="button" class="list-group-item list-group-item-action" data-analysis-id="${analysis.id}">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${analysis.title || 'Sans titre'}</h6>
                            <small>${analysis.updatedAt ? new Date(analysis.updatedAt).toLocaleDateString('fr-FR') : new Date(analysis.createdAt).toLocaleDateString('fr-FR')}</small>
                        </div>
                        <p class="mb-0 text-muted small">${analysis.problem || 'Analyse 5 Pourquoi'}</p>
                    </button>
                `
                )
                .join('');

            listContainer.innerHTML = listHtml;

            // R√©initialiser les ic√¥nes Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Ajouter les event listeners pour charger les analyses
            listContainer.querySelectorAll('[data-analysis-id]').forEach((button) => {
                button.addEventListener('click', async (event) => {
                    const selectedId = event.currentTarget.getAttribute('data-analysis-id');
                    await loadFiveWhy(selectedId);
                    
                    // Fermer le modal via le contr√¥leur bootstrap-modal
                    let modalController = null;
                    
                    if (window.Stimulus && typeof window.Stimulus.getControllerForElementAndIdentifier === 'function') {
                        try {
                            modalController = window.Stimulus.getControllerForElementAndIdentifier(modalElement, 'bootstrap-modal');
                        } catch (e) {
                            console.warn('Impossible de r√©cup√©rer le contr√¥leur Stimulus:', e);
                        }
                    }

                    if (modalController && typeof modalController.hide === 'function') {
                        modalController.hide();
                    } else {
                        // Fallback vers Bootstrap natif
                        const bootstrapLib = window.bootstrap || (await new Promise(resolve => {
                            if (window.bootstrap) resolve(window.bootstrap);
                            else setTimeout(() => resolve(window.bootstrap), 100);
                        }));
                        const bootstrapModal = bootstrapLib?.Modal?.getInstance?.(modalElement);
                        bootstrapModal?.hide();
                    }
                });
            });

            // R√©initialiser les ic√¥nes Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Ouvrir le modal via le contr√¥leur bootstrap-modal
            let modalController = null;
            
            if (window.Stimulus && typeof window.Stimulus.getControllerForElementAndIdentifier === 'function') {
                try {
                    modalController = window.Stimulus.getControllerForElementAndIdentifier(modalElement, 'bootstrap-modal');
                } catch (e) {
                    console.warn('Impossible de r√©cup√©rer le contr√¥leur Stimulus:', e);
                }
            }

            if (modalController && typeof modalController.show === 'function') {
                modalController.show();
            } else {
                // Fallback vers Bootstrap natif
                const bootstrapLib = window.bootstrap || (await new Promise(resolve => {
                    if (window.bootstrap) resolve(window.bootstrap);
                    else setTimeout(() => resolve(window.bootstrap), 100);
                }));
                if (!bootstrapLib?.Modal) {
                    Toastify({
                        text: "Le module d'interface Bootstrap n'est pas disponible.",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                    }).showToast();
                    return;
                }
                const modalInstance = new bootstrapLib.Modal(modalElement);
                modalInstance.show();
            }
        } catch (error) {
            console.error(error);
            Toastify({
                text: error.message || 'Erreur lors du chargement des analyses.',
                duration: 5000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
            }).showToast();
        }
    }

    window.openFiveWhySaved = openFiveWhySaved;

    async function loadFiveWhy(id, { silent = false } = {}) {
        if (!{{ app.user ? 'true' : 'false' }}) {
            return null;
        }

        try {
            const baseUrl = `{{ path('app_tool_fivewhy_get', {id: 0}) }}`;
            const requestUrl = baseUrl.replace(/0$/, String(id));
            const response = await fetch(requestUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });

            const data = await response.json();

            if (response.ok && data.success && data.data) {
                window.loadAnalysisData(data.data.content || {}, { id: data.data.id });
                setCurrentFiveWhyAnalysisId(data.data.id);

                if (!silent) {
                    Toastify({
                        text: "Analyse charg√©e avec succ√®s !",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    }).showToast();
                }

                return data.data;
            }

            throw new Error(data.message || 'Analyse 5 Pourquoi non trouv√©e.');
        } catch (error) {
            console.error('Erreur lors du chargement:', error);
            if (!silent) {
                Toastify({
                    text: "Erreur lors du chargement de l'analyse.",
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff6b6b, #ee5a6f)",
                }).showToast();
            }
            return null;
        }
    }

    function showLoadModal(analyses) {
        const modalHtml = `
            <div class="modal fade" id="loadFiveWhyModal" tabindex="-1" aria-labelledby="loadFiveWhyModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="loadFiveWhyModalLabel">Charger une analyse sauvegard√©e</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="list-group">
                                ${analyses.map(analysis => `
                                    <button type="button" class="list-group-item list-group-item-action" onclick="loadFiveWhy(${analysis.id}); $('#loadFiveWhyModal').modal('hide');">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">${analysis.title || 'Sans titre'}</h6>
                                            <small>${analysis.updatedAt ? new Date(analysis.updatedAt).toLocaleDateString('fr-FR') : new Date(analysis.createdAt).toLocaleDateString('fr-FR')}</small>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const existingModal = document.getElementById('loadFiveWhyModal');
        if (existingModal) {
            existingModal.remove();
        }

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modal = new bootstrap.Modal(document.getElementById('loadFiveWhyModal'));
        modal.show();
    }

    async function autoLoadLatestFiveWhy() {
        if (!window.fiveWhyAppConfig?.isAuthenticated) {
            return;
        }

        const initialId = window.fiveWhyAppConfig.analysisId;
        const currentId = getCurrentFiveWhyAnalysisId();

        if (initialId) {
            await loadFiveWhy(initialId, { silent: true });
            return;
        }

        if (currentId) {
            await loadFiveWhy(currentId, { silent: true });
            return;
        }

        try {
            const response = await fetch('{{ path('app_tool_fivewhy_list') }}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });

            const payload = await response.json();
            if (payload.data && payload.data.length > 0) {
                const latest = payload.data[0];
                if (latest.content) {
                    window.loadAnalysisData(latest.content, { id: latest.id });
                } else {
                    await loadFiveWhy(latest.id, { silent: true });
                }
                setCurrentFiveWhyAnalysisId(latest.id);
            }
        } catch (error) {
            console.error('Erreur lors du chargement automatique de l\'analyse 5 Pourquoi :', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (window.fiveWhyAppConfig?.isAuthenticated) {
            autoLoadLatestFiveWhy();
        }
    });
</script>
{% endblock %}
