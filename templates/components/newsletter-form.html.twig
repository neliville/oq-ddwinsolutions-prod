{# Le formulaire doit être passé depuis le contrôleur #}
{% set form = newsletterForm|default(null) %}

{% if form is null %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Le formulaire newsletter n'est pas disponible.
    </div>
{% else %}

<div class="newsletter-section text-white p-5 rounded-4 text-center">
    <h3 class="fw-bold mb-3">Restez informé des nouveautés</h3>
    <p class="mb-4">Recevez nos derniers articles et outils directement dans votre boîte mail.</p>

    {{ form_start(form, {
        'attr': {
            'class': 'row g-3 justify-content-center',
            'id': 'newsletterForm',
            'action': path('app_newsletter_subscribe'),
            'data-turbo': 'false'
        }
    }) }}
        <div class="col-md-8">
            {{ form_widget(form.email, {'attr': {'class': 'form-control form-control-lg', 'placeholder': 'Votre adresse email'}}) }}
            {{ form_errors(form.email) }}
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-light btn-lg w-100">
                <i class="fas fa-envelope me-2"></i>S'abonner
            </button>
        </div>
        {{ form_rest(form) }}
    {{ form_end(form) }}

    <small class="d-block mt-2 text-muted">
        En soumettant ce formulaire, vous acceptez notre <a href="{{ path('app_legal_politique_confidentialite') }}"
            target="_blank" rel="noopener" title="Politique de confidentialité"
            class="text-decoration-underline">politique de confidentialité</a>.
    </small>
    <small class="d-block mt-3 opacity-75">
        Pas de spam, désinscription en un clic
    </small>

    <div id="newsletterMessage" class="mt-3" style="display: none;"></div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newsletterForm = document.getElementById('newsletterForm');
    const newsletterMessage = document.getElementById('newsletterMessage');

    if (newsletterForm) {
        newsletterForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(newsletterForm);
            const submitButton = newsletterForm.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;

            // Afficher le chargement
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Envoi...';
            submitButton.disabled = true;
            newsletterMessage.style.display = 'none';

            try {
                const response = await fetch('{{ path('app_newsletter_subscribe') }}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: formData
                });

                const data = await response.json();

                newsletterMessage.style.display = 'block';
                
                if (data.success) {
                    newsletterMessage.className = 'mt-3 alert alert-success';
                    newsletterMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + data.message;
                    newsletterForm.reset();
                } else {
                    newsletterMessage.className = 'mt-3 alert alert-danger';
                    newsletterMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + data.message;
                }
            } catch (error) {
                newsletterMessage.style.display = 'block';
                newsletterMessage.className = 'mt-3 alert alert-danger';
                newsletterMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Une erreur est survenue. Veuillez réessayer.';
            } finally {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });
    }
});
</script>

