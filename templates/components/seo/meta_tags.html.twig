{# 
    Composant pour les meta tags SEO
    Capture les blocks SEO définis dans les templates enfants
#}

{# Paramètres par défaut #}
{% set app_name = 'OUTILS-QUALITÉ' %}
{% set app_description = 'Outils qualité gratuits en ligne : diagramme Ishikawa interactif, méthode 5 Pourquoi, export PDF. Outils 100% gratuits pour l\'amélioration continue.' %}
{% set app_keywords = 'diagramme Ishikawa, fishbone diagram, 5 Pourquoi, méthode des 5 pourquoi, analyse des causes racines, root cause analysis, outil qualité gratuit, amélioration continue, PDCA, Pareto, résolution de problèmes' %}
{% set app_url = app.request.schemeAndHttpHost %}
{% set current_url = app.request.uri %}

{# Utiliser les variables passées depuis base.html.twig #}
{# Ces variables contiennent le contenu des blocks SEO capturés depuis les templates enfants #}
{% set seo_title_raw = seo_title_raw|default('')|trim %}
{% set seo_description_raw = seo_description_raw|default('')|trim %}
{% set seo_keywords_raw = seo_keywords_raw|default('')|trim %}
{% set seo_canonical_raw = seo_canonical_raw|default('')|trim %}
{% set seo_robots_raw = seo_robots_raw|default('')|trim %}

{# Titre de la page #}
{% set page_title_raw = seo_title_raw|default('Outils Qualité Gratuits : Analyse & Rapports Express') %}
{% set page_title = page_title_raw %}
{% if not page_title_raw ends with app_name and not page_title_raw ends with 'OUTILS-QUALITÉ' %}
    {% set page_title = page_title_raw ~ ' | ' ~ app_name %}
{% else %}
    {% set page_title = page_title_raw %}
{% endif %}

{# Description de la page #}
{% set page_description_raw = seo_description_raw|default(app_description) %}
{% set page_description = page_description_raw|striptags|trim %}

{# Mots-clés de la page #}
{% set page_keywords = seo_keywords_raw|default(app_keywords) %}

{# Robots #}
{% set robots = seo_robots_raw|default('index, follow') %}

{# URL canonique - normaliser pour éviter les doublons #}
{% if seo_canonical_raw %}
    {% set canonical_url = seo_canonical_raw %}
{% else %}
    {# Générer l'URL canonique depuis la route actuelle #}
    {% set route_name = app.request.attributes.get('_route') %}
    {% if route_name and route_name != 'app_error' %}
        {% try %}
            {% set canonical_url = absolute_url(path(route_name, app.request.attributes.get('_route_params', {}))) %}
        {% catch %}
            {% set canonical_url = app.request.uri %}
        {% endtry %}
    {% else %}
        {% set canonical_url = app.request.uri %}
    {% endif %}
{% endif %}

{# Normaliser l'URL canonique : HTTPS, sans www, sans trailing slash (sauf racine) #}
{# Supprimer www #}
{% set canonical_url = canonical_url|replace({'www.': ''}) %}
{# Forcer HTTPS #}
{% set canonical_url = canonical_url|replace({'http://': 'https://'}) %}
{# Supprimer le trailing slash sauf pour la racine #}
{% if canonical_url|slice(-1) == '/' %}
    {% set url_without_slash = canonical_url|slice(0, -1) %}
    {% if url_without_slash|split('/')|length > 3 %}
        {% set canonical_url = url_without_slash %}
    {% endif %}
{% endif %}

<!-- Meta Tags SEO -->
<title>{{ page_title }}</title>
<meta name="description" content="{{ page_description }}">
<meta name="keywords" content="{{ page_keywords }}">
<meta name="robots" content="{{ robots }}">
<meta name="author" content="{{ app_name }}">

{# URL canonique - toujours présente pour éviter les doublons #}
<link rel="canonical" href="{{ canonical_url }}">

{# Meta tags pour mobile #}
<meta name="theme-color" content="#0d6efd">

