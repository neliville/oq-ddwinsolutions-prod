{% if app.user %}
<aside class="admin-sidebar bg-white border-end position-fixed top-0 start-0 vh-100 d-flex flex-column" style="width: 280px; z-index: 1020; padding-top: 76px; box-shadow: 2px 0 8px rgba(0,0,0,0.1); overflow-y: auto;">
    <div class="p-3 flex-grow-1 overflow-y-auto">
        <!-- Logo et titre -->
        <div class="mb-4 pb-3 border-bottom">
            <div class="d-flex align-items-center mb-3">
                <img src="{{ asset('img/logo.png') }}" alt="OUTILS-QUALITÉ" width="32" height="32" class="me-2">
                <span class="fw-bold text-primary">Dashboard</span>
            </div>
        </div>

        <!-- Menu de navigation principal -->
        <nav class="sidebar-nav">
            <ul class="list-unstyled mb-0">
                <!-- Section : Tableau de bord -->
                <li class="mb-1">
                    <a href="{{ path('app_dashboard_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_dashboard_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="layout-dashboard" width="18" height="18" class="me-2"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>

                <!-- Section : Mes outils -->
                <li class="mb-1 mt-4">
                    <div class="px-3 py-2 text-muted text-uppercase small fw-bold">Mes Outils</div>
                </li>
                <li class="mb-1">
                    <a href="{{ path('app_ishikawa_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_ishikawa_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="git-branch" width="18" height="18" class="me-2"></i>
                        <span>Analyse des causes</span>
                    </a>
                </li>
                <li class="mb-1">
                    <a href="{{ path('app_fivewhy_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_fivewhy_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="help-circle" width="18" height="18" class="me-2"></i>
                        <span>Méthode 5 Pourquoi</span>
                    </a>
                </li>
                <li class="mb-1">
                    <a href="{{ path('app_outils_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_outils_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="tool-case" width="18" height="18" class="me-2"></i>
                        <span>Tous les outils</span>
                    </a>
                </li>

                <!-- Section : Mes contenus -->
                <li class="mb-1 mt-4">
                    <div class="px-3 py-2 text-muted text-uppercase small fw-bold">Mes Contenus</div>
                </li>
                <li class="mb-1">
                    <a href="{{ path('app_creations_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_creations_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="file-text" width="18" height="18" class="me-2"></i>
                        <span>Mes créations</span>
                    </a>
                </li>
                <li class="mb-1">
                    <a href="{{ path('app_blog_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_blog_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="book-open" width="18" height="18" class="me-2"></i>
                        <span>Blog</span>
                    </a>
                </li>

                <!-- Section : Administration (uniquement pour admins) -->
                {% if is_granted('ROLE_ADMIN') %}
                <li class="mb-1 mt-4">
                    <div class="px-3 py-2 text-muted text-uppercase small fw-bold">Administration</div>
                </li>
                <li class="mb-1">
                    <a href="{{ path('app_admin_dashboard_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_admin_dashboard_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="shield" width="18" height="18" class="me-2"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                
                <!-- Sous-menu Utilisateurs -->
                <li class="mb-1">
                    <a class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-dark" data-bs-toggle="collapse" href="#adminUsersMenu" role="button" aria-expanded="false" aria-controls="adminUsersMenu">
                        <i data-lucide="users" width="18" height="18" class="me-2"></i>
                        <span class="flex-grow-1">Utilisateurs</span>
                        <i data-lucide="chevron-down" width="14" height="14" class="chevron-icon"></i>
                    </a>
                    <div class="collapse" id="adminUsersMenu">
                        <ul class="list-unstyled ps-4 mt-1">
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Liste des utilisateurs
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Nouvel utilisateur
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>

                <!-- Sous-menu Articles -->
                <li class="mb-1">
                    <a class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-dark" data-bs-toggle="collapse" href="#adminPostsMenu" role="button" aria-expanded="false" aria-controls="adminPostsMenu">
                        <i data-lucide="file-text" width="18" height="18" class="me-2"></i>
                        <span class="flex-grow-1">Articles Blog</span>
                        <i data-lucide="chevron-down" width="14" height="14" class="chevron-icon"></i>
                    </a>
                    <div class="collapse" id="adminPostsMenu">
                        <ul class="list-unstyled ps-4 mt-1">
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Liste des articles
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Nouvel article
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Catégories
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>

                <!-- Sous-menu Messages -->
                <li class="mb-1">
                    <a class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-dark" data-bs-toggle="collapse" href="#adminMessagesMenu" role="button" aria-expanded="false" aria-controls="adminMessagesMenu">
                        <i data-lucide="mail" width="18" height="18" class="me-2"></i>
                        <span class="flex-grow-1">Messages</span>
                        <i data-lucide="chevron-down" width="14" height="14" class="chevron-icon"></i>
                    </a>
                    <div class="collapse" id="adminMessagesMenu">
                        <ul class="list-unstyled ps-4 mt-1">
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Messages de contact
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Newsletter
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>

                <!-- Sous-menu Statistiques -->
                <li class="mb-1">
                    <a class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-dark" data-bs-toggle="collapse" href="#adminStatsMenu" role="button" aria-expanded="false" aria-controls="adminStatsMenu">
                        <i data-lucide="bar-chart" width="18" height="18" class="me-2"></i>
                        <span class="flex-grow-1">Statistiques</span>
                        <i data-lucide="chevron-down" width="14" height="14" class="chevron-icon"></i>
                    </a>
                    <div class="collapse" id="adminStatsMenu">
                        <ul class="list-unstyled ps-4 mt-1">
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Vues de pages
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded text-muted small">
                                    Utilisateurs actifs
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Section : Autres -->
                <li class="mb-1 mt-4">
                    <div class="px-3 py-2 text-muted text-uppercase small fw-bold">Autres</div>
                </li>
                <li class="mb-1">
                    <a href="{{ path('app_contact_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_contact_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="mail" width="18" height="18" class="me-2"></i>
                        <span>Contact</span>
                    </a>
                </li>
                <li class="mb-1">
                    <a href="{{ path('app_profile_index') }}" class="d-flex align-items-center px-3 py-2 text-decoration-none rounded {% if app.request.get('_route') == 'app_profile_index' %}bg-primary text-white{% else %}text-dark{% endif %}">
                        <i data-lucide="user" width="18" height="18" class="me-2"></i>
                        <span>Mon profil</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Footer sidebar -->
    <div class="border-top bg-white p-3" style="flex-shrink: 0;">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-weight: 600; font-size: 0.875rem;">
                    {{ app.user.email|slice(0, 1)|upper }}
                </div>
                <div class="flex-grow-1">
                    <div class="fw-semibold text-truncate small">{{ app.user.email }}</div>
                    <small class="text-muted">Connecté</small>
                </div>
            </div>
            <a href="{{ path('app_logout') }}" class="btn btn-sm btn-outline-danger w-100 mt-2">
                <i data-lucide="log-out" width="14" height="14" class="me-1"></i>
                Déconnexion
            </a>
        </div>
    </div>
</aside>

<style>
    .admin-sidebar {
        box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }
    .admin-sidebar a:hover {
        background-color: #f8f9fa !important;
    }
    .admin-sidebar a.bg-primary:hover {
        background-color: #0d6efd !important;
    }
    .admin-sidebar .collapse {
        transition: height 0.3s ease;
    }
    .admin-sidebar .chevron-icon {
        transition: transform 0.3s ease;
    }
    .admin-sidebar [aria-expanded="true"] .chevron-icon {
        transform: rotate(180deg);
    }
    @media (max-width: 768px) {
        .admin-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1020 !important;
        }
        .admin-sidebar.show {
            transform: translateX(0);
        }
    }
</style>

<script>
// Fonction pour initialiser la sidebar
function initSidebar() {
    // Initialiser Lucide Icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    
    // Gérer la rotation des chevrons lors du collapse
    const collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseElements.forEach(function(element) {
        // Supprimer les anciens listeners pour éviter les doublons
        const newElement = element.cloneNode(true);
        element.parentNode.replaceChild(newElement, element);
        
        newElement.addEventListener('click', function() {
            const chevron = this.querySelector('.chevron-icon');
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            
            if (chevron) {
                if (isExpanded) {
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    chevron.style.transform = 'rotate(180deg)';
                }
            }
        });
    });

    // Gérer le toggle de la sidebar sur mobile
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.querySelector('.admin-sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    
    if (sidebarToggle && sidebar) {
        // Vérifier si un listener a déjà été attaché (éviter les doublons)
        if (sidebarToggle.dataset.listenerAttached === 'true') {
            return; // Déjà initialisé
        }
        sidebarToggle.dataset.listenerAttached = 'true';
        
        // Fonction pour ouvrir la sidebar
        function openSidebar() {
            sidebar.classList.add('show');
            if (sidebarOverlay) {
                sidebarOverlay.classList.add('show');
                sidebarOverlay.style.display = 'block';
            }
            // Changer l'icône en X
            const icon = sidebarToggle.querySelector('i');
            if (icon && typeof lucide !== 'undefined') {
                icon.setAttribute('data-lucide', 'x');
                lucide.createIcons();
            }
            sidebarToggle.setAttribute('aria-label', 'Fermer le menu');
        }
        
        // Fonction pour fermer la sidebar
        function closeSidebar() {
            sidebar.classList.remove('show');
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove('show');
                setTimeout(() => {
                    sidebarOverlay.style.display = 'none';
                }, 300);
            }
            // Remettre l'icône en menu
            const icon = sidebarToggle.querySelector('i');
            if (icon && typeof lucide !== 'undefined') {
                icon.setAttribute('data-lucide', 'menu');
                lucide.createIcons();
            }
            sidebarToggle.setAttribute('aria-label', 'Ouvrir le menu');
        }
        
        // Ouvrir/fermer la sidebar
        sidebarToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const isOpen = sidebar.classList.contains('show');
            
            if (isOpen) {
                closeSidebar();
            } else {
                openSidebar();
            }
        });

        // Fermer la sidebar en cliquant sur l'overlay
        if (sidebarOverlay) {
            // Vérifier si un listener a déjà été attaché
            if (sidebarOverlay.dataset.listenerAttached === 'true') {
                return;
            }
            sidebarOverlay.dataset.listenerAttached = 'true';
            
            sidebarOverlay.addEventListener('click', function() {
                closeSidebar();
            });
        }

        // Fermer la sidebar en cliquant sur un lien (sur mobile uniquement)
        if (window.innerWidth <= 768) {
            const sidebarLinks = sidebar.querySelectorAll('a');
            sidebarLinks.forEach(function(link) {
                link.addEventListener('click', function() {
                    setTimeout(() => {
                        sidebar.classList.remove('show');
                        if (sidebarOverlay) {
                            const overlay = document.getElementById('sidebarOverlay');
                            if (overlay) {
                                overlay.classList.remove('show');
                                setTimeout(() => {
                                    overlay.style.display = 'none';
                                }, 300);
                            }
                        }
                        // Remettre l'icône en menu
                        const icon = newToggle.querySelector('i');
                        if (icon && typeof lucide !== 'undefined') {
                            icon.setAttribute('data-lucide', 'menu');
                            lucide.createIcons();
                        }
                    }, 100);
                });
            });
        }

        // Gérer le redimensionnement de la fenêtre
        let resizeTimer;
        const handleResize = function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (window.innerWidth > 768) {
                    // Sur desktop, toujours afficher la sidebar
                    sidebar.classList.add('show');
                    if (sidebarOverlay) {
                        const overlay = document.getElementById('sidebarOverlay');
                        if (overlay) {
                            overlay.classList.remove('show');
                            overlay.style.display = 'none';
                        }
                    }
                    // Remettre l'icône en menu (cachée sur desktop)
                    const icon = newToggle.querySelector('i');
                    if (icon && typeof lucide !== 'undefined') {
                        icon.setAttribute('data-lucide', 'menu');
                        lucide.createIcons();
                    }
                } else {
                    // Sur mobile, fermer par défaut si elle était ouverte
                    if (!sidebar.classList.contains('show')) {
                        const overlay = document.getElementById('sidebarOverlay');
                        if (overlay) {
                            overlay.classList.remove('show');
                            overlay.style.display = 'none';
                        }
                    }
                }
            }, 250);
        };
        
        // Supprimer l'ancien listener resize s'il existe
        window.removeEventListener('resize', handleResize);
        window.addEventListener('resize', handleResize);
    }
}

// Initialiser au chargement du DOM
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebar);
} else {
    initSidebar();
}

// Réinitialiser après chaque navigation Turbo
if (typeof window.Turbo !== 'undefined') {
    document.addEventListener('turbo:load', initSidebar);
    document.addEventListener('turbo:frame-load', initSidebar);
}
</script>
{% endif %}

