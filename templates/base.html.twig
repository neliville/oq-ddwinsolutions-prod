<!DOCTYPE html>
<html lang="fr" class="is-loading">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">

    {# Capturer les blocks SEO depuis les templates enfants sans les rendre directement #}
    {% set seo_title_raw %}{% block title %}{% endblock %}{% endset %}
    {% set seo_title_raw = seo_title_raw|trim %}

    {% set seo_description_raw %}{% block meta_description %}{% endblock %}{% endset %}
    {% set seo_description_raw = seo_description_raw|trim %}

    {% set seo_keywords_raw %}{% block meta_keywords %}{% endblock %}{% endset %}
    {% set seo_keywords_raw = seo_keywords_raw|trim %}

    {% set seo_canonical_raw %}{% block canonical_url %}{% endblock %}{% endset %}
    {% set seo_canonical_raw = seo_canonical_raw|trim %}

    {% set seo_robots_raw %}{% block seo_robots %}{% endblock %}{% endset %}
    {% set seo_robots_raw = seo_robots_raw|trim %}

    {% set og_title_raw %}{% block og_title %}{% endblock %}{% endset %}
    {% set og_title_raw = og_title_raw|trim %}

    {% set og_description_raw %}{% block og_description %}{% endblock %}{% endset %}
    {% set og_description_raw = og_description_raw|trim %}

    {% set og_image_raw %}{% block og_image %}{% endblock %}{% endset %}
    {% set og_image_raw = og_image_raw|trim %}

    {% set og_url_raw %}{% block og_url %}{% endblock %}{% endset %}
    {% set og_url_raw = og_url_raw|trim %}

    {% set og_type_raw %}{% block og_type %}{% endblock %}{% endset %}
    {% set og_type_raw = og_type_raw|trim %}

    {% set twitter_card_raw %}{% block twitter_card %}{% endblock %}{% endset %}
    {% set twitter_card_raw = twitter_card_raw|trim %}

    {% set schema_type_raw %}{% block schema_type %}{% endblock %}{% endset %}
    {% set schema_type_raw = schema_type_raw|trim %}

    {% set schema_data_raw %}{% block schema_data %}{% endblock %}{% endset %}
    {% set schema_webapp_raw %}{% block schema_webapp_json %}{% endblock %}{% endset %}
    {% set schema_webapp_raw = schema_webapp_raw|trim %}
    {% set schema_breadcrumb_raw %}{% block schema_breadcrumb_json %}{% endblock %}{% endset %}
    {% set schema_breadcrumb_raw = schema_breadcrumb_raw|trim %}
    {% set schema_social_links_raw %}{% block schema_social_links %}{% endblock %}{% endset %}
    
    {# Passer les valeurs capturées aux composants SEO comme variables #}
    {% include 'components/seo/meta_tags.html.twig' with {
        seo_title_raw: seo_title_raw,
        seo_description_raw: seo_description_raw,
        seo_keywords_raw: seo_keywords_raw,
        seo_canonical_raw: seo_canonical_raw,
        seo_robots_raw: seo_robots_raw
    } %}
    {% include 'components/seo/open_graph.html.twig' with {
        og_title_raw: og_title_raw,
        og_description_raw: og_description_raw,
        og_image_raw: og_image_raw,
        og_url_raw: og_url_raw,
        og_type_raw: og_type_raw,
        twitter_card_raw: twitter_card_raw,
        seo_title_raw: seo_title_raw,
        seo_description_raw: seo_description_raw
    } %}
    {% include 'components/seo/schema_org.html.twig' with {
        schema_type_raw: schema_type_raw,
        schema_data_raw: schema_data_raw,
        schema_webapp_raw: schema_webapp_raw,
        schema_breadcrumb_raw: schema_breadcrumb_raw,
        schema_social_links_raw: schema_social_links_raw
    } %}

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ asset('img/favicon.svg') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ asset('img/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ asset('img/favicon-16x16.png') }}">

    <!-- Preconnect et DNS-prefetch pour performances optimales -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://unpkg.com">

    <!-- Fallback immédiat pour le texte (évite FOIT) + Inter chargé en non-bloquant -->
    <style>body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
    <!-- Google Fonts : entièrement non-bloquant pour réduire le TBT et les requêtes bloquantes -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" media="print" onload="this.media='all'">
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    </noscript>

    <!-- Custom CSS (critique pour le premier rendu, un seul fichier bloquant) -->
    <link href="{{ asset('styles/app.scss') }}" rel="stylesheet">

    {# Import map + app.js : DOIT être dans le head pour que @hotwired/turbo soit résolu avant tout chargement de module #}
    {% block importmap %}{{ importmap('app') }}{% endblock %}

    <!-- Font Awesome et AOS : différés, non bloquants -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'" crossorigin="anonymous">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous"></noscript>
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css"></noscript>

    {% block head %}{% endblock %}

    <style>
        html.is-loading body {
            opacity: 1;
            visibility: visible;
        }
    </style>

    <!-- Google Tag Manager (différé pour améliorer les performances) -->
    <script>
        // Différer le chargement de GTM après le chargement de la page
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', {
            'analytics_storage': 'denied',
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied'
        });
        
        // Charger GTM après le chargement de la page
        function loadGTM() {
            (function(w,d,s,l,i){
                w[l]=w[l]||[];
                w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
                var f=d.getElementsByTagName(s)[0],
                    j=d.createElement(s),
                    dl=l!='dataLayer'?'&l='+l:'';
                j.async=true;
                j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
                f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer','GTM-PNCNWR54');
        }
        
        // Charger GTM après un court délai
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(loadGTM, 1000);
            });
        } else {
            setTimeout(loadGTM, 1000);
        }
    </script>
    <!-- End Google Tag Manager -->

    {% block stylesheets %}
{# Masquer le bandeau BrowserTools MCP (outil de debug externe) #}
<style>
    /* Masquer le bandeau BrowserTools MCP */
    [data-browser-tools],
    iframe[src*="browser-tools"],
    div[id*="browser-tools"],
    div[class*="browser-tools"],
    .browser-tools-banner,
    .mcp-banner {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        position: absolute !important;
        left: -9999px !important;
    }
</style>
    {% endblock %}

    <!-- Matomo -->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//stats.outils-qualite.com/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code -->
</head>

<body>
    {# Skip link pour accessibilité - visible uniquement au focus clavier #}
    <a href="#main-content" class="visually-hidden-focusable btn btn-primary position-absolute top-0 start-0 m-2" style="z-index: 9999;">
        Aller au contenu principal
    </a>

    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PNCNWR54"
                height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    {% set show_sidebar_toggle = show_sidebar_toggle is defined ? show_sidebar_toggle : false %}
    {% set current_route = app.request.attributes.get('_route') %}
    {# Routes publiques qui doivent toujours afficher la navbar publique #}
    {% set public_routes = [
        'app_home_index',
        'app_blog_index',
        'app_blog_article',
        'app_contact_index',
        'app_legal_politique_confidentialite',
        'app_legal_mentions_legales',
        'app_legal_conditions_utilisation',
        'app_outils_index',
        'app_ishikawa_index',
        'app_fivewhy_index',
        'app_qqoqccp_index',
        'app_amdec_index',
        'app_pareto_index',
        'app_eightd_index',
        'app_telechargement_modele_5m',
        'app_merci_modele_5m'
    ] %}
    {% set is_public_route = current_route in public_routes %}
    {% set show_public_navbar = show_public_navbar is defined ? show_public_navbar : (app.user is null or is_public_route) %}

    <!-- Navigation -->
    {% if show_public_navbar %}
        <nav aria-label="Navigation principale">
            {% include 'components/navbar.html.twig' with { show_sidebar_toggle: show_sidebar_toggle } %}
        </nav>
    {% endif %}

    <!-- Main Content -->
    <main id="main-content" tabindex="-1">
        {% block body %}
            {% block content %}{% endblock %}
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer>
        {% include 'components/footer.html.twig' %}
    </footer>

    {# Ancre globale pour les notifications Toastify (Stimulus `notifications`) #}
    <div data-controller="notifications" class="d-none" aria-hidden="true"></div>

    {# Modal de confirmation global réutilisable #}
    {% component ConfirmationModal with {
        id: 'globalConfirmationModal',
        title: 'Confirmation',
        message: 'Êtes-vous sûr de vouloir continuer ?',
        confirmText: 'Confirmer',
        cancelText: 'Annuler',
        confirmClass: 'btn-primary'
    } %}
    {% endcomponent %}

    {% block javascripts %}
    {% endblock %}

    <link rel="stylesheet" href="{{ asset('cookie-banner/silktide-consent-manager.css') }}" media="print" onload="this.media='all'">
    <script src="{{ asset('cookie-banner/silktide-consent-manager.js') }}" defer></script>

    <script>
        function finalizeNonCriticalAssets() {
            document.documentElement.classList.remove('is-loading');

            function runIconsAndAos() {
                if (typeof lucide !== 'undefined') lucide.createIcons();
                if (typeof AOS !== 'undefined') {
                    AOS.init({ duration: 800, easing: 'ease-in-out', once: true, offset: 100 });
                }
            }

            function loadNonCriticalScripts() {
                var run = runIconsAndAos;
                var loaded = { lucide: false, aos: false };
                function maybeRun() {
                    if (loaded.lucide && loaded.aos) run();
                }
                var s1 = document.createElement('script');
                s1.src = 'https://unpkg.com/lucide@latest/dist/umd/lucide.js';
                s1.defer = true;
                s1.onload = function() { loaded.lucide = true; maybeRun(); };
                document.body.appendChild(s1);
                var s2 = document.createElement('script');
                s2.src = 'https://unpkg.com/aos@2.3.1/dist/aos.js';
                s2.defer = true;
                s2.onload = function() { loaded.aos = true; maybeRun(); };
                document.body.appendChild(s2);
            }

            if (typeof requestIdleCallback !== 'undefined') {
                requestIdleCallback(loadNonCriticalScripts, { timeout: 800 });
            } else {
                setTimeout(loadNonCriticalScripts, 100);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', finalizeNonCriticalAssets);
        } else {
            finalizeNonCriticalAssets();
        }
        document.addEventListener('turbo:load', finalizeNonCriticalAssets);
    </script>

    {# Mautic : chargé uniquement en prod (CORS bloque en local depuis 127.0.0.1) #}
    {% if app.environment == 'prod' %}
    <script>
        (function(w,d,t,u,n,a,m){w['MauticTrackingObject']=n;
            w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments)},a=d.createElement(t),
            m=d.getElementsByTagName(t)[0];a.async=1;a.src=u;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://mautic.outils-qualite.com/mtc.js','mt');

        mt('send', 'pageview');
    </script>
    {% endif %}
</body>

</html>
