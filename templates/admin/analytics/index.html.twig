{% extends 'base_with_sidebar.html.twig' %}

{% block title %}Analytics | Administration{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">Analytics et statistiques</h1>
            <p class="text-muted mb-0">Statistiques de visites et d'utilisation</p>
        </div>
        <div>
            <div class="btn-group" role="group" aria-label="Période">
                <a href="{{ path('app_admin_analytics_index', {period: 'today'}) }}" 
                   class="btn btn-sm {{ period == 'today' ? 'btn-primary' : 'btn-outline-primary' }}">
                    Aujourd'hui
                </a>
                <a href="{{ path('app_admin_analytics_index', {period: 'week'}) }}" 
                   class="btn btn-sm {{ period == 'week' ? 'btn-primary' : 'btn-outline-primary' }}">
                    7 jours
                </a>
                <a href="{{ path('app_admin_analytics_index', {period: 'month'}) }}" 
                   class="btn btn-sm {{ period == 'month' ? 'btn-primary' : 'btn-outline-primary' }}">
                    30 jours
                </a>
                <a href="{{ path('app_admin_analytics_index', {period: 'year'}) }}" 
                   class="btn btn-sm {{ period == 'year' ? 'btn-primary' : 'btn-outline-primary' }}">
                    1 an
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Visites totales</h6>
                            <h3 class="fw-bold mb-0">{{ totalVisits|number_format(0, ',', ' ') }}</h3>
                            <small class="text-muted">Période sélectionnée</small>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="bar-chart-2" width="24" height="24" class="text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Aujourd'hui</h6>
                            <h3 class="fw-bold mb-0">{{ todayVisits|number_format(0, ',', ' ') }}</h3>
                            <small class="text-muted">Hier : {{ yesterdayVisits|number_format(0, ',', ' ') }}</small>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="trending-up" width="24" height="24" class="text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Connectés</h6>
                            <h3 class="fw-bold mb-0">{{ authenticatedVisits|number_format(0, ',', ' ') }}</h3>
                            <small class="text-muted">{{ authenticatedVisits > 0 ? ((authenticatedVisits / (authenticatedVisits + anonymousVisits)) * 100)|round(1) : 0 }}%</small>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="users" width="24" height="24" class="text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Anonymes</h6>
                            <h3 class="fw-bold mb-0">{{ anonymousVisits|number_format(0, ',', ' ') }}</h3>
                            <small class="text-muted">{{ anonymousVisits > 0 ? ((anonymousVisits / (authenticatedVisits + anonymousVisits)) * 100)|round(1) : 0 }}%</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="user" width="24" height="24" class="text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques de partage -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Liens partagés (total)</h6>
                            <h3 class="fw-bold mb-0">{{ shareTotals.totalShares|number_format(0, ',', ' ') }}</h3>
                            <small class="text-muted">Depuis le début</small>
                        </div>
                        <div class="bg-secondary bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="share-2" width="24" height="24" class="text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Liens actifs</h6>
                            <h3 class="fw-bold mb-0">{{ shareTotals.activeShares|number_format(0, ',', ' ') }}</h3>
                            <small class="text-muted">Expire après 1 mois</small>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="clock" width="24" height="24" class="text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Partages (30 jours)</h6>
                            <h3 class="fw-bold mb-0">{{ shareTotals.sharesThisMonth|number_format(0, ',', ' ') }}</h3>
                            <small class="text-muted">Créés sur la période</small>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="calendar" width="24" height="24" class="text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Visites via partage</h6>
                            <h3 class="fw-bold mb-0">{{ shareTotals.totalShareVisits|number_format(0, ',', ' ') }}</h3>
                            <small class="text-muted">30j : {{ shareTotals.shareVisitsThisMonth|number_format(0, ',', ' ') }}</small>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="link-2" width="24" height="24" class="text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Pages les plus visitées -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Pages les plus visitées</h5>
                </div>
                <div class="card-body p-0">
                    {% if mostVisitedPages|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>URL</th>
                                    <th class="text-end">Visites</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for page in mostVisitedPages %}
                                <tr>
                                    <td>
                                        <code class="text-truncate d-inline-block" style="max-width: 300px;" title="{{ page.url }}">
                                            {{ page.url }}
                                        </code>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ page.visitCount|number_format(0, ',', ' ') }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i data-lucide="file-text" width="48" height="48" class="text-muted mb-3"></i>
                        <p class="text-muted mb-0">Aucune visite</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Top référents -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Référents les plus fréquents</h5>
                </div>
                <div class="card-body p-0">
                    {% if topReferers|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Référent</th>
                                    <th class="text-end">Visites</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for referer in topReferers %}
                                <tr>
                                    <td>
                                        <a href="{{ referer.referer }}" target="_blank" rel="noopener" class="text-decoration-none">
                                            {{ referer.referer|slice(0, 50) }}{% if referer.referer|length > 50 %}...{% endif %}
                                        </a>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ referer.visitCount|number_format(0, ',', ' ') }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i data-lucide="link" width="48" height="48" class="text-muted mb-3"></i>
                        <p class="text-muted mb-0">Aucun référent</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Données géographiques et appareils -->
        <div class="col-lg-6">
            <!-- Top pays -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Top pays</h5>
                </div>
                <div class="card-body p-0">
                    {% if topCountries|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Pays</th>
                                    <th class="text-end">Visites</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for country in topCountries %}
                                <tr>
                                    <td>
                                        <i data-lucide="map-pin" width="16" height="16" class="me-2"></i>
                                        <strong>{{ country.country }}</strong>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ country.visitCount|number_format(0, ',', ' ') }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i data-lucide="globe" width="48" height="48" class="text-muted mb-3"></i>
                        <p class="text-muted mb-0">Aucune donnée géographique</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Top villes -->
            {% if topCities|length > 0 %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Top villes</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Ville</th>
                                    <th class="text-end">Visites</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for city in topCities %}
                                <tr>
                                    <td>
                                        <i data-lucide="map-pin" width="16" height="16" class="me-2"></i>
                                        <strong>{{ city.city }}</strong>
                                        {% if city.country %}
                                        <small class="text-muted">({{ city.country }})</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ city.visitCount|number_format(0, ',', ' ') }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Top appareils -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Appareils</h5>
                </div>
                <div class="card-body p-0">
                    {% if topDevices|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Appareil</th>
                                    <th class="text-end">Visites</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in topDevices %}
                                <tr>
                                    <td>
                                        <i data-lucide="smartphone" width="16" height="16" class="me-2"></i>
                                        <strong>{{ device.device }}</strong>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ device.visitCount|number_format(0, ',', ' ') }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i data-lucide="smartphone" width="48" height="48" class="text-muted mb-3"></i>
                        <p class="text-muted mb-0">Aucune donnée d'appareil</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tendances -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Tendances de visites</h5>
                    <small class="text-muted">Visites par jour ({{ startDate|date('d/m/Y') }} - {{ endDate|date('d/m/Y') }})</small>
                </div>
                <div class="card-body">
                    {% if visitsByDay|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th class="text-end">Visites</th>
                                    <th class="text-end" style="width: 200px;">Graphique</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set maxVisits = visitsByDay|reduce((max, item) => item.count > max ? item.count : max, 0) %}
                                {% for day in visitsByDay %}
                                {% set percentage = maxVisits > 0 ? (day.count / maxVisits * 100)|round(0) : 0 %}
                                <tr>
                                    <td>
                                        <strong>{{ day.date ? day.date|date('d/m/Y') : '-' }}</strong>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ day.count|number_format(0, ',', ' ') }}</strong>
                                    </td>
                                    <td class="text-end">
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                 style="width: {{ percentage }}%" 
                                                 aria-valuenow="{{ day.count }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="{{ maxVisits }}">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i data-lucide="bar-chart-2" width="48" height="48" class="text-muted mb-3"></i>
                        <p class="text-muted mb-0">Aucune donnée de tendance</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Partages récents et principaux contributeurs -->
    <div class="row g-4 mt-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Top utilisateurs qui partagent</h5>
                </div>
                <div class="card-body p-0">
                    {% if topSharers|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Utilisateur</th>
                                        <th class="text-end">Partages</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for sharer in topSharers %}
                                        <tr>
                                            <td>
                                                <i data-lucide="user" width="16" height="16" class="me-2"></i>
                                                <strong>{{ sharer.email }}</strong>
                                            </td>
                                            <td class="text-end">
                                                <strong>{{ sharer.shareCount|number_format(0, ',', ' ') }}</strong>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i data-lucide="share-2" width="48" height="48" class="text-muted mb-3"></i>
                            <p class="text-muted mb-0">Aucun partage enregistré</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Partages récents</h5>
                </div>
                <div class="card-body p-0">
                    {% if recentShares|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Diagramme</th>
                                        <th>Utilisateur</th>
                                        <th>Créé</th>
                                        <th>Expire</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for share in recentShares %}
                                        <tr>
                                            <td>
                                                <strong>{{ share.title }}</strong><br>
                                                <small class="text-muted">
                                                    <a href="{{ url('app_ishikawa_share_view', {token: share.token}) }}" target="_blank" rel="noopener">
                                                        {{ share.token|slice(0, 12) }}…
                                                    </a>
                                                </small>
                                            </td>
                                            <td>{{ share.owner }}</td>
                                            <td>{{ share.createdAt|date('d/m/Y H:i') }}</td>
                                            <td>{{ share.expiresAt|date('d/m/Y H:i') }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i data-lucide="clock" width="48" height="48" class="text-muted mb-3"></i>
                            <p class="text-muted mb-0">Aucun partage récent</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Analyses les plus consultées via partage</h5>
                </div>
                <div class="card-body p-0">
                    {% if topSharedAnalyses|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Diagramme</th>
                                        <th class="text-end">Visites</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in topSharedAnalyses %}
                                        <tr>
                                            <td>
                                                <i data-lucide="git-branch" width="16" height="16" class="me-2"></i>
                                                <strong>{{ item.title }}</strong>
                                            </td>
                                            <td class="text-end">
                                                <strong>{{ item.visitCount|number_format(0, ',', ' ') }}</strong>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i data-lucide="eye" width="48" height="48" class="text-muted mb-3"></i>
                            <p class="text-muted mb-0">Aucune visite via partage</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Visites récentes via partage</h5>
                </div>
                <div class="card-body p-0">
                    {% if recentShareVisits|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Diagramme</th>
                                        <th>Date</th>
                                        <th>Lien</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for visit in recentShareVisits %}
                                        <tr>
                                            <td>{{ visit.title }}</td>
                                            <td>{{ visit.visitedAt|date('d/m/Y H:i') }}</td>
                                            <td>
                                                <a href="{{ url('app_ishikawa_share_view', {token: visit.token}) }}" target="_blank" rel="noopener">
                                                    {{ visit.token|slice(0, 12) }}…
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i data-lucide="external-link" width="48" height="48" class="text-muted mb-3"></i>
                            <p class="text-muted mb-0">Aucune visite récente</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau détaillé des visites -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Journal des visites</h5>
                        <small class="text-muted">Filtrez et explorez les visites individuelles</small>
                    </div>
                    <form method="get" class="d-flex flex-wrap gap-2 align-items-center">
                        <input type="hidden" name="period" value="{{ period }}">
                        <div class="d-flex gap-2">
                            <div>
                                <label class="form-label mb-1 small text-muted" for="from">Du</label>
                                <input type="date" class="form-control form-control-sm" id="from" name="from" value="{{ filters.from }}">
                            </div>
                            <div>
                                <label class="form-label mb-1 small text-muted" for="to">Au</label>
                                <input type="date" class="form-control form-control-sm" id="to" name="to" value="{{ filters.to }}">
                            </div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <input type="text" class="form-control form-control-sm" placeholder="URL" name="url" value="{{ filters.url }}">
                            <input type="text" class="form-control form-control-sm" placeholder="Référent" name="referer" value="{{ filters.referer }}">
                            <input type="text" class="form-control form-control-sm" placeholder="Email utilisateur" name="userEmail" value="{{ filters.userEmail }}">
                            <input type="text" class="form-control form-control-sm" placeholder="IP" name="ipAddress" value="{{ filters.ipAddress }}">
                            <input type="text" class="form-control form-control-sm" placeholder="Session" name="sessionId" value="{{ filters.sessionId }}">
                            <input type="text" class="form-control form-control-sm" placeholder="Pays" name="country" value="{{ filters.country }}">
                            <input type="text" class="form-control form-control-sm" placeholder="Ville" name="city" value="{{ filters.city }}">
                            <select class="form-select form-select-sm" name="type" aria-label="Filtrer par type">
                                <option value="" {{ filters.type == '' ? 'selected' : '' }}>Tous types</option>
                                <option value="login" {{ filters.type == 'login' ? 'selected' : '' }}>Connexions</option>
                                <option value="page" {{ filters.type == 'page' ? 'selected' : '' }}>Visites de page</option>
                            </select>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                <i data-lucide="filter" class="me-1"></i> Filtrer
                            </button>
                            <a href="{{ path('app_admin_analytics_index', { period: period }) }}" class="btn btn-sm btn-outline-secondary">
                                Réinitialiser
                            </a>
                        </div>
                    </form>
                </div>
                <div class="card-body p-0">
                    <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom bg-light">
                        <div><strong>Total résultats :</strong> {{ totalPageViews }}</div>
                        <form method="get" class="d-flex align-items-center gap-2">
                            <input type="hidden" name="period" value="{{ period }}">
                            {% for key, value in filters %}
                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                            {% endfor %}
                            <label for="pageSize" class="small text-muted mb-0">Par page</label>
                            <select id="pageSize" name="limit" class="form-select form-select-sm" onchange="this.form.submit()">
                                {% for option in [25, 50, 75, 100] %}
                                    <option value="{{ option }}" {{ pageSize == option ? 'selected' : '' }}>{{ option }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light text-nowrap">
                                <tr>
                                    <th>#</th>
                                    <th>Utilisateur</th>
                                    <th>Session</th>
                                    <th>Date</th>
                                    <th>URL</th>
                                    <th>Type</th>
                                    <th>IP</th>
                                    <th>Pays</th>
                                    <th>Ville</th>
                                    <th>Agent</th>
                                    <th>Référent</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if pageViews|length == 0 %}
                                    <tr>
                                        <td colspan="11" class="text-center py-4 text-muted">Aucun résultat pour les filtres sélectionnés.</td>
                                    </tr>
                                {% endif %}
                                {% for visit in pageViews %}
                                    <tr>
                                        <td>{{ loop.index + ((currentPage - 1) * pageSize) }}</td>
                                        <td>
                                            {% if visit.user %}
                                                <span class="fw-semibold">{{ visit.user.email }}</span>
                                            {% else %}
                                                <span class="text-muted">Anonyme</span>
                                            {% endif %}
                                        </td>
                                        <td><code>{{ visit.sessionId ?? '—' }}</code></td>
                                        <td>{{ visit.visitedAt|date('d/m/Y H:i:s') }}</td>
                                        <td>
                                            <code class="d-inline-block text-truncate" style="max-width: 220px;" title="{{ visit.url }}">{{ visit.url }}</code>
                                        </td>
                                        <td>
                                            {% if visit.url matches '/login/' %}
                                                <span class="badge text-bg-warning">Connexion</span>
                                            {% else %}
                                                <span class="badge text-bg-primary">Page</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ visit.ipAddress ?? '—' }}</td>
                                        <td>{{ visit.country ?? '—' }}</td>
                                        <td>{{ visit.city ?? '—' }}</td>
                                        <td>
                                            <span class="d-inline-block text-truncate" style="max-width: 220px;" title="{{ visit.userAgent }}">{{ visit.userAgent ?? '—' }}</span>
                                        </td>
                                        <td>
                                            {% if visit.referer %}
                                                <a href="{{ visit.referer }}" target="_blank" rel="noopener" class="text-decoration-none">
                                                    {{ visit.referer|slice(0, 40) }}{% if visit.referer|length > 40 %}…{% endif %}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center px-3 py-3 border-top bg-white">
                        <div class="text-muted small">
                            Page {{ currentPage }} sur {{ totalPages }} · {{ pageViews|length }} éléments affichés
                        </div>
                        <nav aria-label="Pagination des visites">
                            <ul class="pagination pagination-sm mb-0">
                                {% set prevPage = currentPage - 1 %}
                                <li class="page-item {{ currentPage == 1 ? 'disabled' : '' }}">
                                    <a class="page-link" href="{{ path('app_admin_analytics_index', filters|merge({period: period, page: prevPage > 0 ? prevPage : 1, limit: pageSize})) }}" aria-label="Précédent">
                                        &laquo;
                                    </a>
                                </li>
                                {% for p in 1..totalPages %}
                                    {% if totalPages <= 7 or p == 1 or p == totalPages or (p >= currentPage - 2 and p <= currentPage + 2) %}
                                        <li class="page-item {{ currentPage == p ? 'active' : '' }}">
                                            <a class="page-link" href="{{ path('app_admin_analytics_index', filters|merge({period: period, page: p, limit: pageSize})) }}">{{ p }}</a>
                                        </li>
                                    {% elseif p == currentPage - 3 or p == currentPage + 3 %}
                                        <li class="page-item disabled"><span class="page-link">…</span></li>
                                    {% endif %}
                                {% endfor %}
                                {% set nextPage = currentPage + 1 %}
                                <li class="page-item {{ currentPage == totalPages ? 'disabled' : '' }}">
                                    <a class="page-link" href="{{ path('app_admin_analytics_index', filters|merge({period: period, page: nextPage <= totalPages ? nextPage : totalPages, limit: pageSize})) }}" aria-label="Suivant">
                                        &raquo;
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}
</script>
{% endblock %}
