{% extends 'base_with_sidebar.html.twig' %}

{% block title %}Tableau de bord Administration | OUTILS-QUALITÉ{% endblock %}

{% block meta_description %}
<meta name="description" content="Tableau de bord de l'administration - OUTILS-QUALITÉ">
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">Tableau de bord Administration</h1>
            <p class="text-muted mb-0">Vue d'ensemble de votre application</p>
        </div>
        <div>
            <span class="badge bg-success">
                <i data-lucide="check-circle" width="14" height="14" class="me-1"></i>
                Système opérationnel
            </span>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <!-- Messages de contact non lus -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Messages non lus</h6>
                            <h3 class="fw-bold mb-0">{{ unreadMessagesCount }}</h3>
                            <small class="text-muted">
                                <i data-lucide="mail" width="14" height="14" class="me-1"></i>
                                {{ messagesToday }} aujourd'hui
                            </small>
                        </div>
                        <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="mail" width="24" height="24" class="text-danger"></i>
                        </div>
                    </div>
                    <a href="{{ path('app_admin_contact_index') }}" class="btn btn-sm btn-outline-danger mt-3 w-100">
                        Voir les messages
                    </a>
                </div>
            </div>
        </div>

        <!-- Abonnés newsletter -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Abonnés actifs</h6>
                            <h3 class="fw-bold mb-0">{{ activeSubscribersCount }}</h3>
                            <small class="text-muted">
                                <i data-lucide="user-plus" width="14" height="14" class="me-1"></i>
                                {{ newSubscribersToday }} nouveaux aujourd'hui
                            </small>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="users" width="24" height="24" class="text-primary"></i>
                        </div>
                    </div>
                    <a href="{{ path('app_admin_newsletter_index') }}" class="btn btn-sm btn-outline-primary mt-3 w-100">
                        Gérer la newsletter
                    </a>
                </div>
            </div>
        </div>

        <!-- Visites aujourd'hui -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Visites aujourd'hui</h6>
                            <h3 class="fw-bold mb-0">{{ visitsToday }}</h3>
                            <small class="text-muted">
                                <i data-lucide="trending-up" width="14" height="14" class="me-1"></i>
                                {{ visitsLastWeek }} cette semaine
                            </small>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="bar-chart-2" width="24" height="24" class="text-info"></i>
                        </div>
                    </div>
                    <a href="{{ path('app_admin_analytics_index') }}" class="btn btn-sm btn-outline-info mt-3 w-100">
                        Voir les analytics
                    </a>
                </div>
            </div>
        </div>

        <!-- Articles publiés -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Articles blog</h6>
                            <h3 class="fw-bold mb-0">{{ mostViewedPosts|length }}</h3>
                            <small class="text-muted">
                                <i data-lucide="book-open" width="14" height="14" class="me-1"></i>
                                Articles publiés
                            </small>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="book" width="24" height="24" class="text-success"></i>
                        </div>
                    </div>
                    <a href="{{ path('app_admin_blog_index') }}" class="btn btn-sm btn-outline-success mt-3 w-100">
                        Gérer les articles
                    </a>
                </div>
            </div>
        </div>

        <!-- Leads (utilisation des outils) -->
        <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted text-uppercase small mb-2">Leads</h6>
                            <h3 class="fw-bold mb-0">{{ leadsTotal }}</h3>
                            <small class="text-muted">
                                <i data-lucide="user-plus" width="14" height="14" class="me-1"></i>
                                {{ leadsToday }} aujourd'hui · {{ leadsLastWeek }} cette semaine
                            </small>
                        </div>
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i data-lucide="target" width="24" height="24" class="text-warning"></i>
                        </div>
                    </div>
                    <a href="{{ path('app_admin_leads_index') }}" class="btn btn-sm btn-outline-warning mt-3 w-100">
                        Voir les leads
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques et détails -->
    <div class="row g-4 mb-4">
        <!-- Pages les plus visitées -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i data-lucide="trending-up" width="20" height="20" class="me-2"></i>
                        Pages les plus visitées
                    </h5>
                </div>
                <div class="card-body">
                    {% if mostVisitedPages|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th class="text-end">Visites</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for page in mostVisitedPages %}
                                <tr>
                                    <td>
                                        <code class="small">{{ page['url']|slice(0, 50) }}{% if page['url']|length > 50 %}...{% endif %}</code>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">{{ page['visitCount'] }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i data-lucide="bar-chart-2" width="48" height="48" class="text-muted mb-2"></i>
                        <p class="text-muted mb-0">Aucune visite enregistrée</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Articles les plus vus -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i data-lucide="eye" width="20" height="20" class="me-2"></i>
                        Articles les plus vus
                    </h5>
                </div>
                <div class="card-body">
                    {% if mostViewedPosts|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th class="text-end">Vues</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for post in mostViewedPosts %}
                                <tr>
                                    <td>
                                        <strong>{{ post.title }}</strong>
                                        {% if post.category %}
                                        <br>
                                        <small class="text-muted">{{ post.category.name }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-info">{{ post.views }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i data-lucide="book-open" width="48" height="48" class="text-muted mb-2"></i>
                        <p class="text-muted mb-0">Aucun article publié</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques détaillées -->
    <div class="row g-4 mb-4">
        <!-- Statistiques des messages -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i data-lucide="mail" width="20" height="20" class="me-2"></i>
                        Messages de contact
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Aujourd'hui</span>
                            <strong>{{ messagesToday }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ messagesToday > 0 ? (messagesToday / (messagesLastWeek > 0 ? messagesLastWeek : 1)) * 100 : 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Cette semaine</span>
                            <strong>{{ messagesLastWeek }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ messagesLastWeek > 0 ? (messagesLastWeek / (messagesLastMonth > 0 ? messagesLastMonth : 1)) * 100 : 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-0">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Ce mois</span>
                            <strong>{{ messagesLastMonth }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques newsletter -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i data-lucide="users" width="20" height="20" class="me-2"></i>
                        Newsletter
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Nouveaux aujourd'hui</span>
                            <strong>{{ newSubscribersToday }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ newSubscribersToday > 0 ? (newSubscribersToday / (newSubscribersLastWeek > 0 ? newSubscribersLastWeek : 1)) * 100 : 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Cette semaine</span>
                            <strong>{{ newSubscribersLastWeek }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ newSubscribersLastWeek > 0 ? (newSubscribersLastWeek / (newSubscribersLastMonth > 0 ? newSubscribersLastMonth : 1)) * 100 : 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-0">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Ce mois</span>
                            <strong>{{ newSubscribersLastMonth }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques des visites -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i data-lucide="activity" width="20" height="20" class="me-2"></i>
                        Visites
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Aujourd'hui</span>
                            <strong>{{ visitsToday }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ visitsToday > 0 ? (visitsToday / (visitsLastWeek > 0 ? visitsLastWeek : 1)) * 100 : 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Cette semaine</span>
                            <strong>{{ visitsLastWeek }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ visitsLastWeek > 0 ? (visitsLastWeek / (visitsLastMonth > 0 ? visitsLastMonth : 1)) * 100 : 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-0">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Ce mois</span>
                            <strong>{{ visitsLastMonth }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activité récente et Derniers leads -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i data-lucide="clock" width="20" height="20" class="me-2"></i>
                        Activité récente
                    </h5>
                </div>
                <div class="card-body">
                    {% if recentActivity|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Utilisateur</th>
                                    <th>Action</th>
                                    <th>Entité</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in recentActivity %}
                                <tr>
                                    <td>
                                        <small>{{ activity.createdAt|date('d/m/Y H:i') }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ activity.user.email }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if activity.action == 'CREATE' %}bg-success
                                            {% elseif activity.action == 'UPDATE' %}bg-primary
                                            {% elseif activity.action == 'DELETE' %}bg-danger
                                            {% else %}bg-secondary
                                            {% endif %}">
                                            {{ activity.action }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if activity.entityType %}
                                        <code class="small">{{ activity.entityType }}</code>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if activity.description %}
                                        {{ activity.description|slice(0, 50) }}{% if activity.description|length > 50 %}...{% endif %}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i data-lucide="activity" width="48" height="48" class="text-muted mb-2"></i>
                        <p class="text-muted mb-0">Aucune activité récente</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i data-lucide="target" width="20" height="20" class="me-2"></i>
                        Derniers leads
                    </h5>
                    <a href="{{ path('app_admin_leads_index') }}" class="btn btn-sm btn-outline-warning">Voir tout</a>
                </div>
                <div class="card-body">
                    {% if recentLeads|length > 0 %}
                    <ul class="list-unstyled mb-0">
                        {% for lead in recentLeads %}
                        <li class="d-flex justify-content-between align-items-center py-2 border-bottom border-light">
                            <span class="small">{{ lead.email ?? 'Invité' }}</span>
                            <span class="badge bg-secondary small">{{ lead.tool ?? lead.source ?? '—' }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-center py-4 text-muted small">
                        Aucun lead récent
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}
</script>
{% endblock %}
