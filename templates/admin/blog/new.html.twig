{% extends 'base_with_sidebar.html.twig' %}

{% block title %}Nouvel article | Administration{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfZ5HKe3Xf1FR8Mq74ZVvYIfR0oMw66N53WhzxSp8UOZbKgjMqvkKcznowBmX5DQ9K1YZm0sl5POn7gZpv+Rw==" crossorigin="anonymous" referrerpolicy="no-referrer">
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
function initEasyMDEEditor() {
    const textarea = document.getElementById('{{ form.content.vars.id }}');
    if (!textarea || textarea.dataset.easymdeInitialized === 'true') {
        return;
    }

    const easyMDE = new EasyMDE({
        element: textarea,
        spellChecker: false,
        forceSync: true,
        minHeight: '300px',
        toolbar: [
            'bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list',
            '|', 'link', 'image', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'
        ],
    });

    textarea.dataset.easymdeInitialized = 'true';
    textarea.easyMDEInstance = easyMDE;
}

function destroyEasyMDEEditor() {
    const textarea = document.getElementById('{{ form.content.vars.id }}');
    if (textarea && textarea.easyMDEInstance) {
        textarea.easyMDEInstance.toTextArea();
        textarea.easyMDEInstance = null;
        textarea.dataset.easymdeInitialized = 'false';
    }
}

function initBlogEditors() {
    initEasyMDEEditor();
}

function scheduleBlogEditorsInit() {
    window.requestAnimationFrame(initBlogEditors);
}

document.addEventListener('DOMContentLoaded', scheduleBlogEditorsInit);
document.addEventListener('turbo:load', scheduleBlogEditorsInit);
document.addEventListener('turbo:render', scheduleBlogEditorsInit);
document.addEventListener('turbo:before-cache', destroyEasyMDEEditor);

if (document.readyState !== 'loading') {
    scheduleBlogEditorsInit();
}
</script>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{{ path('app_admin_blog_index') }}" class="btn btn-sm btn-outline-secondary mb-2" data-turbo="false">
                <i data-lucide="arrow-left" width="16" height="16" class="me-1"></i>
                Retour à la liste
            </a>
            <h1 class="h3 fw-bold mb-1">Nouvel article</h1>
            <p class="text-muted mb-0">Créer un nouvel article de blog</p>
        </div>
    </div>

    <!-- Formulaire -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    {{ form_start(form, {'attr': {'novalidate': 'novalidate', 'data-turbo': 'false'}}) }}
                    
                    <div class="mb-3">
                        {{ form_label(form.title, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.title, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.title) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.slug, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.slug, {'attr': {'class': 'form-control', 'placeholder': 'Laissé vide pour génération automatique'}}) }}
                        {{ form_help(form.slug) }}
                        {{ form_errors(form.slug) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.excerpt, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.excerpt, {'attr': {'class': 'form-control', 'rows': 3}}) }}
                        {{ form_errors(form.excerpt) }}
                    </div>

                    <div class="mb-3" data-controller="image-upload" data-image-upload-upload-url-value="{{ path('app_admin_blog_upload_image_preview') }}">
                        {{ form_label(form.featuredImage, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.featuredImage, {'attr': {'class': 'form-control', 'data-image-upload-target': 'input'}}) }}
                        <div class="form-text">Formats acceptés : JPG ou WEBP (4&nbsp;Mo maximum). Dimensions recommandées : min 400x300px, max 4000x3000px.</div>
                        {{ form_errors(form.featuredImage) }}
                        
                        <!-- Loader -->
                        <div class="mt-2 d-none" data-image-upload-target="loading">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <span class="ms-2 text-muted">Génération des variantes optimisées...</span>
                        </div>
                        
                        <!-- Erreur -->
                        <div class="mt-2 alert alert-danger d-none" data-image-upload-target="error" role="alert"></div>
                        
                        <!-- Prévisualisation -->
                        <div class="mt-3 d-none" data-image-upload-target="previewWrapper" id="blog-image-preview-new-wrapper">
                            <p class="small text-muted mb-2">Aperçu de l'image sélectionnée</p>
                            <img data-image-upload-target="preview" id="blog-image-preview-new" src="#" alt="Aperçu de l'image" class="img-fluid rounded shadow-sm mb-2">
                            <div data-image-upload-target="variants"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-action="click->image-upload#clearPreview">
                                <i data-lucide="x" width="14" height="14" class="me-1"></i>
                                Supprimer l'aperçu
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.content, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.content, {'attr': {'class': 'form-control', 'rows': 15}}) }}
                        {{ form_errors(form.content) }}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.category, null, {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.category, {'attr': {'class': 'form-select'}}) }}
                            {{ form_errors(form.category) }}
                        </div>

                        <div class="col-md-6 mb-3">
                            {{ form_label(form.readTime, null, {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.readTime, {'attr': {'class': 'form-control', 'placeholder': '5 min'}}) }}
                            {{ form_errors(form.readTime) }}
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.tags, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.tags, {'attr': {'class': 'form-select'}}) }}
                        {{ form_help(form.tags) }}
                        {{ form_errors(form.tags) }}
                        <small class="form-text text-muted">Maintenez Ctrl (ou Cmd sur Mac) pour sélectionner plusieurs tags</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.publishedAt, null, {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.publishedAt, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.publishedAt) }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form_widget(form.featured, {'attr': {'class': 'form-check-input'}}) }}
                            {{ form_label(form.featured, null, {'label_attr': {'class': 'form-check-label'}}) }}
                        </div>
                        {{ form_errors(form.featured) }}
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i data-lucide="save" width="16" height="16" class="me-1"></i>
                            Enregistrer
                        </button>
                        <button type="submit" name="publish_now" value="1" class="btn btn-success">
                            <i data-lucide="send" width="16" height="16" class="me-1"></i>
                            Enregistrer et publier
                        </button>
                        <a href="{{ path('app_admin_blog_index') }}" class="btn btn-outline-secondary">
                            Annuler
                        </a>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>
        </div>

        <!-- Sidebar avec aide -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h6 class="mb-0">Aide</h6>
                </div>
                <div class="card-body">
                    <h6 class="small text-muted text-uppercase mb-2">Conseils</h6>
                    <ul class="small mb-3">
                        <li>Le slug sera généré automatiquement depuis le titre si laissé vide</li>
                        <li>L'extrait sera affiché dans la liste des articles</li>
                        <li>Utilisez "Enregistrer et publier" pour publier immédiatement</li>
                        <li>Les articles publiés sont visibles publiquement</li>
                    </ul>

                    <h6 class="small text-muted text-uppercase mb-2">Conseils supplémentaires</h6>
                    <ul class="small mb-0">
                        <li>Choisissez une catégorie appropriée</li>
                        <li>Ajoutez des tags pertinents</li>
                        <li>Rédigez un extrait accrocheur</li>
                        <li>Utilisez un titre SEO-friendly</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}

// Génération automatique du slug depuis le titre
document.getElementById('{{ form.title.vars.id }}')?.addEventListener('input', function(e) {
    const slugInput = document.getElementById('{{ form.slug.vars.id }}');
    if (slugInput && !slugInput.value) {
        const title = e.target.value;
        const slug = title
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        slugInput.value = slug;
    }
});
</script>
{% endblock %}

