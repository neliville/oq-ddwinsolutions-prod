{% extends 'base_with_sidebar.html.twig' %}

{% block title %}Nouvel article | Administration{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfZ5HKe3Xf1FR8Mq74ZVvYIfR0oMw66N53WhzxSp8UOZbKgjMqvkKcznowBmX5DQ9K1YZm0sl5POn7gZpv+Rw==" crossorigin="anonymous" referrerpolicy="no-referrer">
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
let editorInitTimeout = null;
let editorInitAttempts = 0;
const MAX_INIT_ATTEMPTS = 10;

function initEasyMDEEditor() {
    const textarea = document.getElementById('{{ form.content.vars.id }}');
    
    // Si le textarea n'existe pas ou est d√©j√† initialis√©, on arr√™te
    if (!textarea || textarea.dataset.easymdeInitialized === 'true') {
        return;
    }

    // V√©rifier si Font Awesome est charg√© en testant si les ic√¥nes sont pr√©sentes
    const faLink = document.querySelector('link[href*="font-awesome"]');
    if (faLink && !document.fonts || editorInitAttempts >= MAX_INIT_ATTEMPTS) {
        // Initialiser directement si on ne peut pas d√©tecter ou apr√®s plusieurs tentatives
        createEditor(textarea);
        return;
    }

    // Attendre que Font Awesome soit compl√®tement charg√©
    if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => {
            // Petit d√©lai suppl√©mentaire pour s'assurer que les ic√¥nes sont disponibles
            setTimeout(() => {
                createEditor(textarea);
            }, 100);
        }).catch(() => {
            // En cas d'erreur, initialiser quand m√™me
            createEditor(textarea);
        });
    } else {
        // Fallback : attendre un peu plus
        setTimeout(() => {
            createEditor(textarea);
        }, 200);
    }
}

function createEditor(textarea) {
    if (textarea.dataset.easymdeInitialized === 'true') {
        return;
    }

    try {
        const easyMDE = new EasyMDE({
            element: textarea,
            spellChecker: false,
            forceSync: true,
            minHeight: '300px',
            toolbar: [
                'bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list',
                '|', 'link', 'image', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide'
            ],
        });

        textarea.dataset.easymdeInitialized = 'true';
        textarea.easyMDEInstance = easyMDE;
        
        console.log('EasyMDE initialized successfully');
    } catch (error) {
        console.error('Error initializing EasyMDE:', error);
        
        // R√©essayer si on n'a pas atteint le max de tentatives
        if (editorInitAttempts < MAX_INIT_ATTEMPTS) {
            editorInitAttempts++;
            setTimeout(() => {
                initEasyMDEEditor();
            }, 300);
        }
    }
}

function destroyEasyMDEEditor() {
    const textarea = document.getElementById('{{ form.content.vars.id }}');
    if (textarea && textarea.easyMDEInstance) {
        try {
            textarea.easyMDEInstance.toTextArea();
            textarea.easyMDEInstance = null;
            textarea.dataset.easymdeInitialized = 'false';
        } catch (error) {
            console.error('Error destroying EasyMDE:', error);
        }
    }
    
    // Nettoyer le timeout si pr√©sent
    if (editorInitTimeout) {
        clearTimeout(editorInitTimeout);
        editorInitTimeout = null;
    }
    
    // R√©initialiser le compteur
    editorInitAttempts = 0;
}

function scheduleBlogEditorsInit() {
    // Annuler toute initialisation en cours
    if (editorInitTimeout) {
        clearTimeout(editorInitTimeout);
    }
    
    // R√©initialiser le compteur
    editorInitAttempts = 0;
    
    // Programmer l'initialisation avec un d√©lai pour laisser la page se charger
    editorInitTimeout = setTimeout(() => {
        initEasyMDEEditor();
    }, 150);
}

// √âv√©nements de chargement
document.addEventListener('DOMContentLoaded', scheduleBlogEditorsInit);
document.addEventListener('turbo:load', scheduleBlogEditorsInit);
document.addEventListener('turbo:render', scheduleBlogEditorsInit);
document.addEventListener('turbo:before-cache', destroyEasyMDEEditor);

// Si la page est d√©j√† charg√©e
if (document.readyState !== 'loading') {
    scheduleBlogEditorsInit();
}

// Nettoyage avant de quitter la page
window.addEventListener('beforeunload', destroyEasyMDEEditor);
</script>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    {% for message in app.flashes('danger') %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
        </div>
    {% endfor %}
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{{ path('app_admin_blog_index') }}" class="btn btn-sm btn-outline-secondary mb-2" data-turbo="false">
                <i data-lucide="arrow-left" width="16" height="16" class="me-1"></i>
                Retour √† la liste
            </a>
            <h1 class="h3 fw-bold mb-1">Nouvel article</h1>
            <p class="text-muted mb-0">Cr√©er un nouvel article de blog</p>
        </div>
    </div>

    <!-- Formulaire -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    {{ form_start(form, {'attr': {'novalidate': 'novalidate', 'data-turbo': 'false'}}) }}
                    
                    <div class="mb-3">
                        {{ form_label(form.title, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.title, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.title) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.slug, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.slug, {'attr': {'class': 'form-control', 'placeholder': 'Laiss√© vide pour g√©n√©ration automatique'}}) }}
                        {{ form_help(form.slug) }}
                        {{ form_errors(form.slug) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.excerpt, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.excerpt, {'attr': {'class': 'form-control', 'rows': 3}}) }}
                        {{ form_errors(form.excerpt) }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Image √† la une</label>
                        <p class="form-text text-muted small mb-2">Indiquez une URL ou t√©l√©versez un fichier (le fichier est prioritaire si les deux sont renseign√©s).</p>
                        <div class="mb-2">
                            {{ form_row(form.featuredImageUrl, {'label': false, 'attr': {'class': 'form-control', 'placeholder': 'https://exemple.com/image.jpg'}}) }}
                        </div>
                        <div data-controller="image-upload" data-image-upload-upload-url-value="{{ path('app_admin_blog_upload_image_preview') }}">
                            {{ form_row(form.featuredImage, {'label': 'Ou t√©l√©verser un fichier (JPG ou WEBP)', 'label_attr': {'class': 'form-label'}, 'attr': {'class': 'form-control', 'data-image-upload-target': 'input'}}) }}
                        </div>
                        <div class="form-text">Fichier : 4&nbsp;Mo max. Dimensions recommand√©es : min 400√ó300px, max 4000√ó3000px.</div>
                        {{ form_errors(form.featuredImage) }}
                        
                        <div class="mt-2 d-none" data-image-upload-target="loading">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <span class="ms-2 text-muted">G√©n√©ration des variantes optimis√©es...</span>
                        </div>
                        
                        <div class="mt-2 alert alert-danger d-none" data-image-upload-target="error" role="alert"></div>
                        
                        <!-- Pr√©visualisation -->
                        <div class="mt-3 d-none" data-image-upload-target="previewWrapper" id="blog-image-preview-new-wrapper">
                            <p class="small text-muted mb-2">Aper√ßu de l'image s√©lectionn√©e</p>
                            <img data-image-upload-target="preview" id="blog-image-preview-new" src="#" alt="Aper√ßu de l'image" class="img-fluid rounded shadow-sm mb-2">
                            <div data-image-upload-target="variants"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-action="click->image-upload#clearPreview">
                                <i data-lucide="x" width="14" height="14" class="me-1"></i>
                                Supprimer l'aper√ßu
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            {{ form_label(form.content, null, {'label_attr': {'class': 'form-label mb-0'}}) }}
                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#markdownHelp">
                                <i data-lucide="help-circle" width="14" height="14" class="me-1"></i>
                                Aide Markdown & Ancres
                            </button>
                        </div>
                        
                        <!-- Aide Markdown -->
                        <div class="collapse mb-3" id="markdownHelp">
                            <div class="card card-body bg-light">
                                <h6 class="fw-bold mb-2">üí° Sommaire automatique</h6>
                                <p class="small mb-2">Ins√©rez <code>[TOC]</code> ou <code>[[TOC]]</code> n'importe o√π dans votre article pour g√©n√©rer automatiquement un sommaire √† partir de vos titres (h2-h6).</p>
                                
                                <h6 class="fw-bold mb-2 mt-3">üîó Ancres automatiques</h6>
                                <p class="small mb-2">Chaque titre g√©n√®re automatiquement une ancre. Par exemple :</p>
                                <ul class="small mb-2">
                                    <li><code>## Introduction</code> ‚Üí ancre <code>#introduction</code></li>
                                    <li><code>### √âtape 1 : Diagnostic</code> ‚Üí ancre <code>#etape-1-diagnostic</code></li>
                                </ul>
                                
                                <h6 class="fw-bold mb-2 mt-3">üìù Syntaxe Markdown</h6>
                                <div class="row small">
                                    <div class="col-md-6">
                                        <code>## Titre niveau 2</code><br>
                                        <code>### Titre niveau 3</code><br>
                                        <code>**gras**</code><br>
                                        <code>*italique*</code>
                                    </div>
                                    <div class="col-md-6">
                                        <code>[lien](#ancre)</code><br>
                                        <code>![image](url)</code><br>
                                        <code>- liste</code><br>
                                        <code>`code`</code>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{ form_widget(form.content, {'attr': {'class': 'form-control', 'rows': 15}}) }}
                        {{ form_errors(form.content) }}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.category, null, {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.category, {'attr': {'class': 'form-select'}}) }}
                            {{ form_errors(form.category) }}
                        </div>

                        <div class="col-md-6 mb-3">
                            {{ form_label(form.readTime, null, {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.readTime, {'attr': {'class': 'form-control', 'placeholder': '5 min'}}) }}
                            {{ form_errors(form.readTime) }}
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.tags, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.tags, {'attr': {'class': 'form-select'}}) }}
                        {{ form_help(form.tags) }}
                        {{ form_errors(form.tags) }}
                        <small class="form-text text-muted">Maintenez Ctrl (ou Cmd sur Mac) pour s√©lectionner plusieurs tags</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.publishedAt, null, {'label_attr': {'class': 'form-label'}}) }}
                            {{ form_widget(form.publishedAt, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.publishedAt) }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form_widget(form.featured, {'attr': {'class': 'form-check-input'}}) }}
                            {{ form_label(form.featured, null, {'label_attr': {'class': 'form-check-label'}}) }}
                        </div>
                        {{ form_errors(form.featured) }}
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i data-lucide="save" width="16" height="16" class="me-1"></i>
                            Enregistrer
                        </button>
                        <button type="submit" name="publish_now" value="1" class="btn btn-success">
                            <i data-lucide="send" width="16" height="16" class="me-1"></i>
                            Enregistrer et publier
                        </button>
                        <a href="{{ path('app_admin_blog_index') }}" class="btn btn-outline-secondary">
                            Annuler
                        </a>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>
        </div>

        <!-- Sidebar avec aide -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h6 class="mb-0">Aide</h6>
                </div>
                <div class="card-body">
                    <h6 class="small text-muted text-uppercase mb-2">Conseils</h6>
                    <ul class="small mb-3">
                        <li>Le slug sera g√©n√©r√© automatiquement depuis le titre si laiss√© vide</li>
                        <li>L'extrait sera affich√© dans la liste des articles</li>
                        <li>Utilisez "Enregistrer et publier" pour publier imm√©diatement</li>
                        <li>Les articles publi√©s sont visibles publiquement</li>
                    </ul>

                    <h6 class="small text-muted text-uppercase mb-2">Conseils suppl√©mentaires</h6>
                    <ul class="small mb-0">
                        <li>Choisissez une cat√©gorie appropri√©e</li>
                        <li>Ajoutez des tags pertinents</li>
                        <li>R√©digez un extrait accrocheur</li>
                        <li>Utilisez un titre SEO-friendly</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}

// G√©n√©ration automatique du slug depuis le titre
document.getElementById('{{ form.title.vars.id }}')?.addEventListener('input', function(e) {
    const slugInput = document.getElementById('{{ form.slug.vars.id }}');
    if (slugInput && !slugInput.value) {
        const title = e.target.value;
        const slug = title
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        slugInput.value = slug;
    }
});
</script>
{% endblock %}

