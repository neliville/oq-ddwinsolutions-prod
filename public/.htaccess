# Configuration Apache pour optimiser les performances et le SEO

# Activer la compression GZIP/Brotli pour réduire la taille des fichiers (économie ~70%)
<IfModule mod_deflate.c>
    # Compresser HTML, CSS, JavaScript, JSON, XML
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
    # Compresser également SVG et autres formats texte
    AddOutputFilterByType DEFLATE image/svg+xml application/xhtml+xml application/rss+xml
    # Compresser les polices
    AddOutputFilterByType DEFLATE application/x-font-ttf application/x-font-otf font/opentype font/ttf font/eot font/otf

    # Ne pas compresser les images déjà compressées
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|ico)$ no-gzip dont-vary

    # Assurer un en-tête Vary correct pour le caching
    <IfModule mod_headers.c>
        Header append Vary Accept-Encoding
    </IfModule>
</IfModule>

# Brotli compression (si disponible, meilleure que GZIP)
<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json application/xml
    AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
</IfModule>

# Configuration des durées de cache pour améliorer les performances
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images - cache 1 an (avec versioning dans les noms de fichiers)
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS et JavaScript versionnés - cache 1 an
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    
    # Fonts - cache 1 an
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML - pas de cache (toujours frais)
    ExpiresByType text/html "access plus 0 seconds"
    
    # JSON, XML - cache 1 heure
    ExpiresByType application/json "access plus 1 hour"
    ExpiresByType application/xml "access plus 1 hour"
    ExpiresByType text/xml "access plus 1 hour"
</IfModule>

# Headers de cache pour les fichiers statiques versionnés
<IfModule mod_headers.c>
    # Dossier Asset Mapper : cache long et immutable (fichiers hashés)
    <If "%{REQUEST_URI} =~ /^\/assets\//">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </If>

    # Cache 1 an pour les fichiers avec hash dans le nom (versionnés)
    <FilesMatch "\.(js|css|woff|woff2|png|jpg|jpeg|gif|webp|svg|ico)$">
        <If "%{REQUEST_URI} =~ /[a-zA-Z0-9]{8,}/">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </If>
        <Else>
            Header set Cache-Control "public, max-age=604800"
        </Else>
    </FilesMatch>

    # Pas de cache pour HTML
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# Redirection vers index.php pour Symfony
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Rediriger vers HTTPS si disponible
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Normaliser www/non-www (choisir une version canonique - ici non-www)
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
    
    # Rediriger les anciennes URLs article-template.html vers le blog
    RewriteCond %{REQUEST_URI} ^/article-template\.html [NC]
    RewriteRule ^article-template\.html$ /blog/ [R=301,L]
    
    # Rediriger les anciennes URLs .html vers les nouvelles routes (sauf fichiers statiques)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_URI} ^/(ishikawa|5pourquoi|outils|blog|contact)\.html$ [NC]
    RewriteRule ^(.*)\.html$ /$1/ [R=301,L]
    
    # Rediriger les URLs avec trailing slash vers sans trailing slash (sauf pour la racine)
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteCond %{REQUEST_URI} !^/$
    RewriteRule ^ %1 [R=301,L]
    
    # Rediriger vers index.php si le fichier n'existe pas
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>

# Sécurité - masquer les informations du serveur
<IfModule mod_headers.c>
    Header unset Server
    Header unset X-Powered-By

    # Performance et sécurité headers
    # Preload (permet au navigateur de précharger des ressources avant d'analyser le HTML)
    Header add Link "</styles/app.css>; rel=preload; as=style"
    Header add Link "</app.js>; rel=modulepreload"

    # Optimisations pour mobile - permettre au navigateur de gérer les ressources efficacement
    # Early Hints (103) pour les ressources critiques - améliore le chargement mobile
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"

    # Référer Policy - équilibre entre privacy et analytics
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Optimisation des performances pour mobile - éviter les requêtes inutiles
<IfModule mod_headers.c>
    # ETags pour la validation de cache
    FileETag MTime Size

    # Ajouter les en-têtes de timing pour mesurer les performances
    Header set Timing-Allow-Origin "*"
</IfModule>

